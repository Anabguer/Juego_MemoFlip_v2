<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoFlip - Juego</title>
    <link rel="stylesheet" href="game.css">
    
    <!-- Scripts modulares -->
    <script src="game-firebase.js"></script>
    <script src="game-core.js"></script>
    <script src="game-ui.js"></script>
</head>
<body>


    <!-- Fondo forzado -->
    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #312e81, #581c87, #0f172a); z-index: -1;"></div>
    
    <!-- Spinner de carga peque√±o -->
    <div id="loading-spinner-small" class="loading-spinner-small" style="display: none;">
        <div class="spinner-small"></div>
        <div class="loading-text-small">Cargando datos...</div>
    </div>

    <!-- Contenedor principal - EXACTO como tu dise√±o -->
    <div class="game-content">
        <div class="game-wrapper">
                <!-- Fila 1: Logo centrado + controles -->
                <div class="header-row">
                    <!-- Selector de modo bonito -->
                    <div class="mode-selector-header">
                        <div class="mode-selector-container">
                            <button class="mode-pill" id="modePill" onclick="toggleModeSelector()">
                                <img class="mode-icon" id="modeIcon" src="relax.png" alt="Relax">
                                <span class="mode-text" id="modeText">Relax</span>
                                <span class="mode-arrow">‚ñº</span>
                            </button>
                            <button class="help-btn-game" onclick="showModeHelp()" title="Ayuda de modos">?</button>
                        </div>
                        
                        <!-- Dropdown de modos -->
                        <div class="mode-dropdown" id="modeDropdown">
                            <div class="mode-dropdown-title">Modo de juego</div>
                            <button class="mode-option" onclick="changeMode('beginner')">
                                <img class="mode-option-icon" src="relax.png" alt="Relax">
                                <span class="mode-option-text">Relax</span>
                            </button>
                            <button class="mode-option" onclick="changeMode('normal')">
                                <img class="mode-option-icon" src="normal.png" alt="Normal">
                                <span class="mode-option-text">Normal</span>
                            </button>
                            <button class="mode-option" onclick="changeMode('extreme')">
                                <img class="mode-option-icon" src="extremo.png" alt="Extremo">
                                <span class="mode-option-text">Extremo</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Logo centrado -->
                    <img src="logo.png" alt="MemoFlip" class="logo" onclick="goToMainMenu()" style="cursor: pointer;">
                    
                    <!-- Controles a la derecha -->
                    <div class="header-controls">
                        <button class="control-btn" onclick="showRanking()" title="Ranking">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy w-5 h-5 text-white" aria-hidden="true">
                                <path d="M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"></path>
                                <path d="M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"></path>
                                <path d="M18 9h1.5a1 1 0 0 0 0-5H18"></path>
                                <path d="M4 22h16"></path>
                                <path d="M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"></path>
                                <path d="M6 9H4.5a1 1 0 0 1 0-5H6"></path>
                            </svg>
                        </button>
                        
                        
                        <button class="control-btn" onclick="showSettings()" title="Ajustes">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </button>
                        
                    </div>
                </div>
                
                <!-- Fila 2: Coraz√≥n izquierda + monedas derecha -->
                <div class="stats-row">
                    <div class="stat-item">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                        <span id="lives">3</span>
                        <div id="lifeTimer" class="life-timer"></div>
                    </div>
                    
                    <div class="user-nick">
                        <span id="userNick">Usuario</span>
                    </div>
                    
                    <div class="stat-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coins w-5 h-5 text-white" aria-hidden="true">
                            <circle cx="8" cy="8" r="6"></circle>
                            <path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path>
                            <path d="M7 6h1v4"></path>
                            <path d="m16.71 13.88.7.71-2.82 2.82"></path>
                        </svg>
                        <span id="coin-counter">0</span>
                    </div>
                    
                </div>
                
                <!-- Nivel, tiempo y controles -->
                <div class="game-header">
                    <div class="level-info">
                        <!-- Nivel con espacio -->
                        <h2>Nivel&nbsp;<span id="currentLevel">1</span></h2>
                    </div>
                    
                    <div class="time-stats">
                        <div class="time-item">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            <span id="gameTime">00:00</span>
                        </div>
                        
                        <div class="time-item">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                            <span id="totalFlips">0</span>
                        </div>
                    </div>
                    
                    <!-- Barra de tiempo l√≠mite -->
                    <div id="time-bar-wrapper" class="time-bar-container" style="display: none;">
                        <div class="time-bar" id="time-bar" style="width: 0%;"></div>
                    </div>
                    
                    <div class="pause-btn">
                        <button class="control-btn" onclick="togglePause()" title="Pausa" id="pause-play-btn">
                            <svg class="icon pause-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                            </svg>
                            <svg class="icon play-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
    
    <!-- √Årea de juego -->
    <div class="game-area">
        <div class="cards-grid-container">
            <div id="cardsGrid" class="cards-grid">
                <!-- Las cartas se generar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Informaci√≥n de Mec√°nica -->
        <div id="mechanicInfo" class="mechanic-info">
            <div class="mechanic-content">
                <img class="mechanic-icon" src="basic.png" alt="Mec√°nica B√°sica">
                <div class="mechanic-text">
                    <h3>Mec√°nica B√°sica</h3>
                    <p>Encuentra las parejas iguales</p>
                </div>
                <button class="mechanic-help" onclick="showMechanicHelp()">?</button>
            </div>
        </div>
    </div>
    
    
    <!-- ===== MODAL DE VICTORIA ===== -->
    <div id="modal-victory" class="modal-overlay hidden">
        <div class="modal-backdrop"></div>
        
        <div class="modal-box modal-victory">
            <!-- Header -->
            <div class="modal-header">
                <h2 class="header-title">¬°Nivel Superado!</h2>
            </div>
            
            <!-- Content -->
            <div class="modal-content">
                <!-- Trofeo con resplandor -->
                <div class="trophy-container">
                    <div class="trophy">üèÜ</div>
                </div>
                
                <!-- Estad√≠sticas -->
                <div class="stats-cards-container">
                    <div class="stat-card">
                        <div class="stat-card-icon">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                    </div>
                        <div class="stat-card-content">
                            <div class="stat-card-label">Tiempo</div>
                            <div class="stat-card-value" id="time-played">0:45</div>
                    </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                        </div>
                        <div class="stat-card-content">
                            <div class="stat-card-label">Giros</div>
                            <div class="stat-card-value" id="flips-count">12</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coins w-5 h-5 text-white" aria-hidden="true">
                                <circle cx="8" cy="8" r="6"></circle>
                                <path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path>
                                <path d="M7 6h1v4"></path>
                                <path d="m16.71 13.88.7.71-2.82 2.82"></path>
                            </svg>
                        </div>
                        <div class="stat-card-content">
                            <div class="stat-card-label">Monedas</div>
                            <div class="stat-card-value" id="coins-earned">+20</div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√≥n -->
                <div class="modal-actions">
                    <button class="btn btn-next-level" id="btn-next-level">
                        SIGUIENTE NIVEL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL DE DERROTA ===== -->
    <div id="modal-defeat" class="modal-overlay hidden">
        <div class="modal-backdrop"></div>
        
        <div class="modal-box modal-defeat">
            <!-- Header -->
            <div class="modal-header">
                <div class="header-icon">
                    <span class="icon">‚ù§Ô∏è</span>
                </div>
                <h2 class="header-title">¬°Tiempo Agotado!</h2>
            </div>
            
            <!-- Content -->
            <div class="modal-content">
                <!-- Coraz√≥n roto con shake -->
                <div class="broken-heart-container">
                    <div class="broken-heart">üíî</div>
                </div>
                
                <!-- Informaci√≥n -->
                <div class="info-container">
                    <p class="info-text">
                        Se acab√≥ el tiempo para el nivel <strong id="failed-level">1</strong>
                    </p>
                    
                    <!-- Estad√≠sticas en cards horizontales -->
                    <div class="stats-cards-container">
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                </svg>
                        </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Tiempo</div>
                                <div class="stat-card-value" id="time-limit">1:00</div>
                        </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coins w-5 h-5 text-white" aria-hidden="true">
                                    <circle cx="8" cy="8" r="6"></circle>
                                    <path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path>
                                    <path d="M7 6h1v4"></path>
                                    <path d="m16.71 13.88.7.71-2.82 2.82"></path>
                                </svg>
                            </div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Monedas</div>
                                <div class="stat-card-value" id="coins-earned-fail">5</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-icon">‚ù§Ô∏è</div>
                            <div class="stat-card-content">
                                <div class="stat-card-label">Vidas</div>
                                <div class="stat-card-value" id="lives-remaining">2</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones -->
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="btn-exit">Salir</button>
                    <button class="btn btn-retry" id="btn-retry">Reintentar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL SIN VIDAS ===== -->
    <div id="modal-no-lives" class="modal-overlay hidden">
        <div class="modal-backdrop"></div>
        
        <div class="modal-box modal-no-lives">
            <!-- Header con bot√≥n cerrar -->
            <div class="modal-header">
                <div class="header-left">
                    <div class="header-icon">
                        <span class="icon">‚ù§Ô∏è</span>
                    </div>
                    <h2 class="header-title">¬°Sin Vidas!</h2>
                </div>
                <button class="btn-close" id="btn-close-no-lives">‚úï</button>
            </div>
            
            <!-- Content -->
            <div class="modal-content">
                <!-- Coraz√≥n roto -->
                <div class="broken-heart-container">
                    <div class="broken-heart">üíî</div>
                </div>
                
                <!-- Informaci√≥n -->
                <div class="info-container">
                    <p class="info-text">
                        Te has quedado sin vidas. Puedes esperar o ver un anuncio.
                    </p>
                    
                    <!-- Timer de regeneraci√≥n -->
                    <div class="regen-box">
                        <div class="regen-header">
                            <span class="regen-icon">‚è∞</span>
                            <span class="regen-label">Pr√≥xima vida en:</span>
                        </div>
                        <div class="regen-timer" id="life-timer">29:59</div>
                        <p class="regen-info">Las vidas se regeneran cada 30 minutos</p>
                    </div>
                </div>
                
                <!-- Bot√≥n -->
                <div class="modal-actions">
                    <button class="btn btn-watch-ad" id="btn-watch-ad">
                        Ver Video
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL DE CONFIGURACI√ìN ===== -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-backdrop" onclick="closeSettingsModal()"></div>
        
        <div class="settings-modal-box">
            <!-- Header -->
            <div class="settings-header">
                <div class="header-left">
                    <div class="header-icon">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </div>
                    <h2 class="header-title">Configuraci√≥n</h2>
                </div>
                <button class="btn-close" onclick="closeSettingsModal()">‚úï</button>
            </div>
            
            <!-- Content -->
            <div class="settings-content">
                
            <!-- AUDIO -->
            <div class="settings-section">
                <h3 class="section-title">Audio</h3>
                
                <!-- M√∫sica de fondo -->
                <div class="setting-item-compact">
                    <div class="setting-info">
                        <span class="setting-icon" id="music-icon">üéµ</span>
                        <div class="setting-text">
                            <p class="setting-name" id="music-name">M√∫sica de fondo</p>
                        </div>
                    </div>
                    <div class="setting-controls">
                        <button class="setting-toggle active" id="music-toggle" onclick="toggleMusic()">
                            Desactivar
                        </button>
                        <input type="range" class="volume-slider" id="music-volume" min="0" max="1" step="0.1" value="0.7" onchange="updateMusicVolume(this.value)">
                    </div>
                </div>
                
                <!-- Sonidos de efectos -->
                <div class="setting-item-compact">
                    <div class="setting-info">
                        <span class="setting-icon" id="sound-icon">üîî</span>
                        <div class="setting-text">
                            <p class="setting-name" id="sound-name">Efectos de sonido</p>
                        </div>
                    </div>
                    <div class="setting-controls">
                        <button class="setting-toggle active" id="sound-toggle" onclick="toggleSound()">
                            Desactivar
                        </button>
                        <input type="range" class="volume-slider" id="sound-volume" min="0" max="1" step="0.1" value="0.8" onchange="updateSoundVolume(this.value)">
                    </div>
                </div>
            </div>
            
                <!-- VIBRACI√ìN -->
                <div class="settings-section">
                    <h3 class="section-title">Vibraci√≥n</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-icon" id="vibration-icon">üì±</span>
                            <div class="setting-text">
                                <p class="setting-name" id="vibration-name">Vibraci√≥n Activada</p>
                                <p class="setting-desc" id="vibration-desc">Vibraci√≥n al tocar cartas</p>
                            </div>
                        </div>
                        <button class="setting-toggle active" id="vibration-toggle" onclick="toggleVibration()">
                            Desactivar
                        </button>
                    </div>
                </div>
                
                
                <!-- CUENTA -->
                <div class="settings-section">
                    <h3 class="section-title">Cuenta</h3>
                    
                    <!-- Usuario NO logueado -->
                    <div id="account-logged-out">
                        <p class="account-info">
                            Inicia sesi√≥n para guardar tu progreso
                        </p>
                        <button class="btn-google" onclick="loginWithGoogleFromGame()">
                            <svg class="google-icon" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Entrar con Google
                        </button>
                    </div>
                    
                    <!-- Usuario logueado -->
                    <div id="account-logged-in" class="hidden">
                        <!-- Email del usuario -->
                        <div class="user-info-box">
                            <p class="user-label">Usuario:</p>
                            <p class="user-email" id="user-email">ejemplo@gmail.com</p>
                        </div>
                        
                        <!-- Bot√≥n cerrar sesi√≥n -->
                        <button class="btn-logout" onclick="logout()">
                            <span class="btn-icon">üö™</span>
                            Cerrar sesi√≥n
                        </button>
                        
                        <!-- Bot√≥n eliminar cuenta -->
                        <button class="btn-delete-account" onclick="deleteAccount()">
                            <span class="btn-icon">üóëÔ∏è</span>
                            Eliminar cuenta
                        </button>
                    </div>
                </div>
                
            </div>
            
            <!-- CONTACTO SIMPLE -->
            <div class="contact-simple">
                <p class="contact-text-simple">
                    <span class="contact-emoji">üìß</span>
                    Problemas y sugerencias: info@intocables13.com
                </p>
            </div>
            
            <!-- Footer -->
            <div class="settings-footer">
                <p>MemoFlip v1.0 - Desarrollado con ‚ù§Ô∏è</p>
            </div>
        </div>
    </div>

    <!-- ===== MODAL ANUNCIO DE MEC√ÅNICAS ===== -->
    <div id="mechanic-intro" class="mechanic-intro-overlay">
        <div class="mechanic-intro-box">
            <h3 class="mechanic-intro-title">¬°Desaf√≠o Especial!</h3>
            
            <div class="mechanic-list" id="mechanic-list">
                <!-- Las mec√°nicas se agregan din√°micamente -->
            </div>
            
            <p class="mechanic-intro-footer">¬°Demuestra tu habilidad!</p>
        </div>
    </div>

    <!-- Modal Ranking -->
    <!-- Modal de Ayuda de Mec√°nicas -->
    <div id="mechanic-help-modal" class="modal-overlay hidden">
        <div class="modal-backdrop" onclick="closeMechanicHelp()"></div>
        <div class="mechanic-help-box">
            <div class="mechanic-help-header">
                <h2>Mec√°nicas del Juego</h2>
                <button class="btn-close" onclick="closeMechanicHelp()">‚úï</button>
            </div>
            <div class="mechanic-help-list" id="mechanic-help-list">
                <!-- Se rellena din√°micamente -->
            </div>
        </div>
    </div>

    <div id="ranking-modal" class="modal-overlay hidden">
        <div class="modal-backdrop" onclick="closeRankingModal()"></div>
        
        <div class="ranking-modal-box">
            <!-- Header -->
            <div class="ranking-header">
                <div class="header-left">
                    <div class="header-icon trophy">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy">
                            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                            <path d="M4 22h16"></path>
                            <path d="M10 14.66V17c0 .55.47.98.97 1.21l1 .42c.17.07.35.1.53.1s.36-.03.53-.1l1-.42c.5-.23.97-.66.97-1.21v-2.34"></path>
                            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                        </svg>
                    </div>
                    <h2 id="ranking-title">Ranking</h2>
                </div>
                <button class="btn-close" onclick="closeRankingModal()">‚úï</button>
            </div>
            
            <!-- Content (3 estados posibles) -->
            <div class="ranking-content">
                
                <!-- Estados de loading y error eliminados -->
                
                <!-- ESTADO 3: √âXITO - LISTA DE JUGADORES -->
                <div id="ranking-success" class="ranking-state hidden">
                    <!-- Icono central -->
                    <div class="ranking-trophy-badge">
                        <div class="trophy-badge">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy">
                                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                                <path d="M4 22h16"></path>
                                <path d="M10 14.66V17c0 .55.47.98.97 1.21l1 .42c.17.07.35.1.53.1s.36-.03.53-.1l1-.42c.5-.23.97-.66.97-1.21v-2.34"></path>
                                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
                            </svg>
                        </div>
                    </div>
                    
                    
                    <!-- Tabla de ranking -->
                    <div class="ranking-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Nick</th>
                                    <th>Nivel</th>
                                    <th>Monedas</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-list">
                                <!-- Datos cargados din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Cargar Lottie para animaciones -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="partida_ganada.js"></script>
    
    <!-- Cargar datos de niveles -->
    <!-- Los archivos de niveles se cargar√°n din√°micamente seg√∫n el modo -->
    
    <script>
        // Variables globales necesarias para los sistemas
        let soundEnabled = true;
        let vibrationEnabled = true;
        
        // ===== SISTEMA DE VIDAS POR MODO =====
        const LifeSystem = {
            maxLives: 3,
            regenTime: 1800000, // 30 minutos en ms
            regenInterval: null,
            
            // Inicializar
            init() {
                // Inicializar vidas por defecto para todos los modos si no existen
                const modes = ['beginner', 'normal', 'extreme'];
                modes.forEach(mode => {
                    const saved = localStorage.getItem(`memoflip_lives_${mode}`);
                    if (!saved) {
                        // Inicializar con vidas m√°ximas SOLO para usuarios nuevos
                        const initialData = {
                            lives: this.maxLives,
                            lastLifeLost: new Date().toISOString()
                        };
                        localStorage.setItem(`memoflip_lives_${mode}`, JSON.stringify(initialData));
                        // Vidas inicializadas
                    }
                });
                
                // Verificar regeneraci√≥n autom√°tica al inicializar
                    this.checkRegeneration();
                
                // Actualizar display
                this.updateDisplay();
                
                // Verificar regeneraci√≥n autom√°tica cada 5 segundos para mayor precisi√≥n
                setInterval(() => {
                    this.checkRegeneration();
                }, 5000);
                
                // NO guardar autom√°ticamente en Firestore al inicializar
                // Solo se guarda cuando hay cambios reales
            },
            
            // Obtener vidas del modo actual
            getCurrentLives(mode = null) {
                const currentMode = mode || localStorage.getItem('memoflip_selected_mode') || 'normal';
                const saved = localStorage.getItem(`memoflip_lives_${currentMode}`);
                if (saved) {
                    const data = JSON.parse(saved);
                    return data.lives;
                }
                return this.maxLives;
            },
            
            // Obtener tiempo de √∫ltima vida perdida del modo actual
            getLastLifeLost(mode = null) {
                const currentMode = mode || localStorage.getItem('memoflip_selected_mode') || 'normal';
                const saved = localStorage.getItem(`memoflip_lives_${currentMode}`);
                if (saved) {
                    const data = JSON.parse(saved);
                    return data.lastLifeLost || 0;
                }
                return 0;
            },
            
            
            // Forzar guardado correcto de vidas en Firestore
            forceSaveLives() {
                if (window.saveGameProgress) {
                    console.log('üíæ Forzando guardado de vidas...');
                    window.saveGameProgress();
                }
            },
            
            // Perder vida en el modo actual
            loseLife() {
                const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                const currentLives = this.getCurrentLives(currentMode);
                
                if (currentLives > 0) {
                    const newLives = currentLives - 1;
                    this.saveModeLives(currentMode, newLives, Date.now());
                    
                    console.log(`üíî Vida perdida en modo ${currentMode}. Quedan: ${newLives}`);
                    
                    this.updateDisplay();
                    
                    // Guardar en Firestore despu√©s de perder vida
                    if (window.saveGameProgress) {
                        setTimeout(() => {
                            window.saveGameProgress();
                        }, 500);
                    }
                    
                    // Si se qued√≥ sin vidas, mostrar modal
                    if (newLives === 0) {
                        console.log('üö® VIDAS LLEGARON A 0 - LLAMANDO showNoLivesModal()');
                        showNoLivesModal();
                    }
                }
            },
            
            // Ganar vida en el modo actual (por ver anuncio)
            gainLife() {
                const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                const currentLives = this.getCurrentLives(currentMode);
                
                if (currentLives < this.maxLives) {
                    const newLives = currentLives + 1;
                    this.saveModeLives(currentMode, newLives, this.getLastLifeLost(currentMode));
                    
                    // Vida ganada
                    
                    this.updateDisplay();
                    
                    // Guardar en Firestore despu√©s de ganar vida
                    if (window.saveGameProgress) {
                        setTimeout(() => {
                            window.saveGameProgress();
                        }, 500);
                    }
                }
            },
            
            // Verificar regeneraci√≥n autom√°tica de vidas (cada 30 minutos)
            checkRegeneration() {
                const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                const currentLives = this.getCurrentLives(currentMode);
                
                // Verificando regeneraci√≥n
                
                // Solo regenerar si no tienes el m√°ximo de vidas
                if (currentLives < this.maxLives) {
                    const lastLifeLost = this.getLastRegenTime(currentMode);
                    const now = Date.now();
                    const timeSinceLastLife = now - lastLifeLost;
                    const regenerationInterval = 30 * 60 * 1000; // 30 minutos en milisegundos
                    
                    // Verificando tiempo de regeneraci√≥n
                    
                    if (timeSinceLastLife >= regenerationInterval) {
                        const newLives = Math.min(currentLives + 1, this.maxLives);
                        this.saveModeLives(currentMode, newLives, now);
                        
                        // Vida regenerada autom√°ticamente
                        
                        this.updateDisplay();
                        
                        // Guardar inmediatamente en Firestore despu√©s de regeneraci√≥n
                        if (window.saveGameProgress) {
                            console.log('üíæ Guardando progreso despu√©s de regeneraci√≥n de vida...');
                            window.saveGameProgress();
                        }
                    } else {
                        const remainingTime = regenerationInterval - timeSinceLastLife;
                        // Solo mostrar log si faltan menos de 60 segundos para evitar spam
                        if (remainingTime <= 60000) {
                            console.log(`‚è∞ Faltan ${Math.round(remainingTime / 1000)}s para regenerar vida`);
                        }
                    }
                } else {
                    console.log(`‚è∞ Ya tienes el m√°ximo de vidas (${this.maxLives}) en modo ${currentMode}`);
                }
            },
            
            // Tiempo hasta la pr√≥xima vida del modo actual
            getTimeUntilNext(mode = null) {
                const currentMode = mode || localStorage.getItem('memoflip_selected_mode') || 'normal';
                const currentLives = this.getCurrentLives(currentMode);
                
                if (currentLives >= this.maxLives) return 0;
                
                const lastLifeLost = this.getLastLifeLost(currentMode);
                const now = Date.now();
                const timeSince = now - lastLifeLost;
                const timeUntilNext = this.regenTime - (timeSince % this.regenTime);
                
                return Math.max(0, timeUntilNext);
            },
            
            // Formatear tiempo MM:SS
            formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },
            
            // Actualizar display
            updateDisplay() {
                const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                const currentLives = this.getCurrentLives(currentMode);
                
                document.getElementById('lives').textContent = currentLives;
                
                // Mostrar timer si no tiene todas las vidas
                const timerElement = document.querySelector('.life-timer');
                if (timerElement && currentLives < this.maxLives) {
                    const timeLeft = this.getTimeUntilNext(currentMode);
                    timerElement.textContent = this.formatTime(timeLeft);
                    timerElement.style.display = 'inline';
                } else if (timerElement) {
                    timerElement.style.display = 'none';
                }
            },
            
            // Guardar vidas de un modo espec√≠fico
            saveModeLives(mode, lives, lastLifeLost) {
                localStorage.setItem(`memoflip_lives_${mode}`, JSON.stringify({
                    lives: lives,
                    lastLifeLost: lastLifeLost
                }));
            },
            
            // Obtener tiempo de regeneraci√≥n (para compatibilidad)
            getLastRegenTime(mode = null) {
                const currentMode = mode || localStorage.getItem('memoflip_selected_mode') || 'normal';
                const lastLifeLost = this.getLastLifeLost(currentMode);
                return new Date(lastLifeLost).getTime();
            }
        };

        // Hacer LifeSystem accesible globalmente
        window.LifeSystem = LifeSystem;

        // ===== SISTEMA DE CARGA INTELIGENTE =====
        const LoadingSystem = {
            isLoading: false,
            pendingFirebaseData: {
                normal: false,
                beginner: false,
                extreme: false
            },
            
            // Mostrar spinner peque√±o
            showLoading() {
                this.isLoading = true;
                const spinnerSmall = document.getElementById('loading-spinner-small');
                if (spinnerSmall) {
                    spinnerSmall.style.display = 'flex';
                }
                console.log('‚è≥ Mostrando spinner de carga...');
            },
            
            // Ocultar spinner peque√±o
            hideLoading() {
                if (this.isLoading) {
                    this.isLoading = false;
                    const spinnerSmall = document.getElementById('loading-spinner-small');
                    if (spinnerSmall) {
                        spinnerSmall.style.display = 'none';
                    }
                    console.log('‚úÖ Spinner de carga ocultado - datos listos');
                }
            },
            
            // Marcar que se esperan datos de Firebase
            expectFirebaseData() {
                this.pendingFirebaseData = {
                    normal: true,
                    beginner: true,
                    extreme: true
                };
                this.showLoading();
                
                // Timeout de seguridad - ocultar pantalla de carga despu√©s de 10 segundos
                setTimeout(() => {
                    if (this.isLoading) {
                        console.log('‚è∞ Timeout de carga - ocultando pantalla de carga');
                        this.hideLoading();
                    }
                }, 10000);
            },
            
            // Marcar que se recibieron datos de un modo
            receivedFirebaseData(mode) {
                this.pendingFirebaseData[mode] = false;
                console.log(`üì• Datos de Firebase recibidos para modo ${mode}`);
                
                // Verificar si todos los datos est√°n listos
                const allReceived = Object.values(this.pendingFirebaseData).every(received => !received);
                if (allReceived) {
                    console.log('‚úÖ Todos los datos de Firebase recibidos');
                    setTimeout(() => {
                        this.hideLoading();
                    }, 500); // Peque√±a pausa para que se vea que se cargaron
                }
            }
        };

        // ===== SISTEMA DE SINCRONIZACI√ìN SIMPLE =====
        const SyncSystem = {
            isDirty: false,
            lastSync: 0,
            syncInterval: 3 * 60 * 1000, // 3 minutos
            
            // Marcar como sucio (hay cambios locales)
            markDirty() {
                this.isDirty = true;
                console.log('üîÑ Datos marcados como sucios - pendiente de sincronizaci√≥n');
            },
            
            // Sincronizaci√≥n suave en background
            async softSync() {
                if (!this.isDirty) return;
                
                const user = localStorage.getItem('user');
                if (!user || !window.AndroidInterface) return;
                
                try {
                    const userData = JSON.parse(user);
                    console.log('üîÑ Sincronizaci√≥n suave en background...');
                    
                    // Push de cambios locales
                    await this.pushLocalChanges(userData);
                    
                    // Pull suave de Firebase (sin bloquear UI)
                    this.pullFromFirebase(userData.uid);
                    
                    this.isDirty = false;
                    this.lastSync = Date.now();
                } catch (error) {
                    console.error('‚ùå Error en sincronizaci√≥n suave:', error);
                }
            },
            
            // Push de cambios locales
            async pushLocalChanges(userData) {
                // Solo push si hay cambios significativos
                const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                const progressKey = `memoflip_progress_${currentMode}`;
                const progress = JSON.parse(localStorage.getItem(progressKey) || '{}');
                
                if (progress.level > 1 || progress.coins > 0) {
                    window.AndroidInterface.saveGameProgress(JSON.stringify({
                        uid: userData.uid,
                        mode: currentMode,
                        progress: progress,
                        lastUpdated: new Date().toISOString()
                    }));
                }
            },
            
            // Pull suave de Firebase
            pullFromFirebase(uid) {
                // Solo si hay red y no estamos en medio de una partida
                if (window.AndroidInterface && window.AndroidInterface.getUserProgress) {
                    const modes = ['normal', 'beginner', 'extreme'];
                    modes.forEach(mode => {
                        window.AndroidInterface.getUserProgress(uid, mode);
                    });
                }
            },
            
            // Iniciar sincronizaci√≥n peri√≥dica
            startPeriodicSync() {
                setInterval(() => {
                    this.softSync();
                }, this.syncInterval);
                console.log('üîÑ Sincronizaci√≥n peri√≥dica iniciada (cada 3 minutos)');
            }
        };

        // ===== SISTEMA DE MONEDAS COMPLETO =====
        const CoinSystem = {
            totalCoins: 0,
            
            // Inicializar
            init() {
                // Cargar monedas del modo actual (sin monedas globales)
                const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                const progressKey = `memoflip_progress_${currentMode}`;
                const progress = JSON.parse(localStorage.getItem(progressKey) || '{}');
                
                this.totalCoins = parseInt(progress.coins || 0);
                console.log(`ü™ô CoinSystem inicializado con ${this.totalCoins} monedas (modo ${currentMode})`);
                this.updateDisplay();
            },
            
            // Agregar monedas
            addCoins(amount) {
                this.totalCoins += amount;
                console.log(`ü™ô +${amount} monedas. Total: ${this.totalCoins}`);
                this.updateDisplay();
            },
            
            // Actualizar display
            updateDisplay() {
                const coinsElement = document.getElementById('coin-counter');
                if (coinsElement) {
                    coinsElement.textContent = this.totalCoins.toLocaleString();
                }
            },
            
        };

        // ===== SISTEMA DE CRON√ìMETRO COMPLETO =====
        const TimerSystem = {
            timeLimit: 0,          // Tiempo l√≠mite del nivel (cuenta atr√°s)
            timeElapsed: 0,        // Tiempo transcurrido
            actualGameTime: 0,     // Tiempo real jugado (cuenta adelante)
            totalFlips: 0,         // Contador de giros
            timerInterval: null,
            gameTimerInterval: null,
            hasStarted: false,     // Si ya empez√≥ el juego
            isPaused: false,       // Si est√° pausado
            
            // Iniciar nivel con cron√≥metro
            startLevel(timeLimitSec) {
                this.timeLimit = timeLimitSec;
                this.timeElapsed = 0;
                this.actualGameTime = 0;
                this.totalFlips = 0;
                this.hasStarted = false;
                this.isPaused = false;
                
                // Limpiar timers anteriores
                this.stop();
                
                // Mostrar/ocultar barra de tiempo
                const timeBarWrapper = document.getElementById('time-bar-wrapper');
                if (timeBarWrapper) {
                    if (timeLimitSec > 0) {
                        timeBarWrapper.style.display = 'block';
                    } else {
                        timeBarWrapper.style.display = 'none';
                    }
                }
                
                // Actualizar displays a 0
                this.updateDisplay();
                this.updateTimeDisplay();
                this.updateFlipsDisplay();
                
                console.log('üéÆ Nivel iniciado. Esperando primer clic...');
            },
            
            // Cron√≥metro de l√≠mite (cuenta atr√°s)
            startCountdown() {
                this.timerInterval = setInterval(() => {
                    if (!this.isPaused) {
                        this.timeElapsed++;
                        
                        // Verificar si se agot√≥ el tiempo
                        if (this.timeElapsed >= this.timeLimit) {
                            this.onTimeUp();
                            return;
                        }
                        
                        this.updateDisplay();
                    }
                }, 1000);
            },
            
            // Cron√≥metro de tiempo jugado (cuenta adelante)
            startGameTimer() {
                this.gameTimerInterval = setInterval(() => {
                    if (!this.isPaused) {
                        this.actualGameTime++;
                        this.updateTimeDisplay();
                    }
                }, 1000);
            },
            
            // Tiempo agotado
            onTimeUp() {
                clearInterval(this.timerInterval);
                clearInterval(this.gameTimerInterval);
                
                console.log('‚è∞ Tiempo agotado!');
                
                // Perder vida
                LifeSystem.loseLife();
                
                // Mostrar modal de derrota
                showDefeatModal();
            },
            
            // Pausar
            pause() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                if (this.gameTimerInterval) clearInterval(this.gameTimerInterval);
            },
            
            // Reanudar
            resume() {
                if (this.timeLimit > 0) this.startCountdown();
                this.startGameTimer();
            },
            
            // Detener
            // Pausar/Reanudar
            togglePause() {
                this.isPaused = !this.isPaused;
                console.log('‚è∏Ô∏è Juego pausado:', this.isPaused);
                return this.isPaused;
            },
            
            stop() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                if (this.gameTimerInterval) clearInterval(this.gameTimerInterval);
            },
            
            // Contar giros
            incrementFlips() {
                // Iniciar cron√≥metros al primer giro
                this.startOnFirstClick();
                
                this.totalFlips++;
                this.updateFlipsDisplay();
            },
            
            // Iniciar cron√≥metros al primer clic
            startOnFirstClick() {
                if (this.hasStarted) return;
                
                this.hasStarted = true;
                console.log('‚è∞ Cron√≥metros iniciados (primer clic)');
                
                // Iniciar cron√≥metro de l√≠mite (si existe)
                if (this.timeLimit > 0) {
                    this.startCountdown();
                }
                
                // Siempre iniciar cron√≥metro de tiempo real
                this.startGameTimer();
            },
            
            // Actualizar barra de progreso
            updateDisplay() {
                if (this.timeLimit > 0) {
                    const percentage = (this.timeElapsed / this.timeLimit) * 100;
                    const timeBar = document.getElementById('time-bar');
                    if (timeBar) {
                        timeBar.style.width = percentage + '%';
                    }
                }
            },
            
            // Actualizar tiempo jugado
            updateTimeDisplay() {
                const minutes = Math.floor(this.actualGameTime / 60);
                const seconds = this.actualGameTime % 60;
                const timeDisplay = document.getElementById('gameTime');
                if (timeDisplay) {
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            },
            
            // Actualizar contador de giros
            updateFlipsDisplay() {
                const flipCounter = document.getElementById('totalFlips');
                if (flipCounter) {
                    flipCounter.textContent = this.totalFlips;
                }
            },
            
            // Formatear tiempo
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        };

        // Sistema de sonidos
        const soundSystem = {
            sounds: {},
            load(name, url) {
                const audio = new Audio(url);
                this.sounds[name] = audio;
            },
            play(name) {
                // Verificar si los sonidos est√°n habilitados
                const settings = getSettings();
                if (!settings.soundEnabled) {
                    console.log('üîá Sonidos deshabilitados, no reproduciendo:', name);
                    return;
                }
                
                if (this.sounds[name]) {
                    this.sounds[name].currentTime = 0;
                    this.sounds[name].volume = settings.soundVolume;
                    this.sounds[name].play().catch(e => console.log('Sonido no disponible:', name));
                }
            }
        };
        
        // Cargar sonidos
        soundSystem.load('cartavolteada', 'sounds/cartavolteada.mp3');
        soundSystem.load('matchexitoso', 'sounds/matchexitoso.mp3');
        soundSystem.load('acierto', 'sounds/acierto.mp3');
        soundSystem.load('fallo', 'sounds/fallo.mp3');
        soundSystem.load('fondo', 'sounds/fondo.mp3');
        
        // Sistema de m√∫sica de fondo
        const backgroundMusic = {
            audio: null,
            isPlaying: false,
            volume: 0.3, // Volumen m√°s bajo para m√∫sica de fondo
            
            init() {
                console.log('üéµ Inicializando m√∫sica de fondo...');
                this.audio = new Audio('sounds/fondo.mp3');
                this.audio.loop = true;
                
                // Usar volumen de configuraci√≥n del usuario
                const settings = getSettings();
                this.audio.volume = settings.musicVolume;
                
                this.audio.preload = 'auto';
                
                // Agregar listeners para debug
                this.audio.addEventListener('loadstart', () => console.log('üéµ M√∫sica: loadstart'));
                this.audio.addEventListener('loadeddata', () => console.log('üéµ M√∫sica: loadeddata'));
                this.audio.addEventListener('canplay', () => {
                    console.log('üéµ M√∫sica: canplay');
                    // Intentar reproducir autom√°ticamente si las configuraciones lo permiten
                    this.tryAutoPlay();
                });
                this.audio.addEventListener('error', (e) => console.log('üéµ M√∫sica: error', e));
                
                console.log('üéµ M√∫sica de fondo inicializada');
            },
            
            // Intentar reproducir autom√°ticamente al cargar
            tryAutoPlay() {
                // Verificar si el usuario ha interactuado (desde index.html)
                const userInteracted = localStorage.getItem('memoflip_user_interacted');
                if (!userInteracted) {
                    console.log('üéµ Usuario no ha interactuado a√∫n, esperando primer clic...');
                    return;
                }
                
                // Verificar si se debe reproducir m√∫sica (desde index.html)
                const shouldPlayMusic = localStorage.getItem('memoflip_should_play_music');
                if (!shouldPlayMusic) {
                    console.log('üéµ No se debe reproducir m√∫sica autom√°ticamente');
                    return;
                }
                
                // Limpiar la bandera despu√©s de usarla
                localStorage.removeItem('memoflip_should_play_music');
                
                // Verificar si hay usuario logueado
                const user = localStorage.getItem('user');
                if (!user) {
                    // No hay usuario logueado - reproducir por defecto
                    console.log('üéµ No hay usuario logueado, reproduciendo por defecto...');
                    this.play();
                    return;
                }
                
                // Hay usuario logueado - verificar sus configuraciones
                const settings = getSettings();
                if (!settings.musicEnabled) {
                    console.log('üéµ Usuario logueado tiene m√∫sica deshabilitada, no reproduciendo');
                    return;
                }
                
                // Usuario logueado con m√∫sica habilitada - reproducir
                console.log('üéµ Usuario logueado con m√∫sica habilitada, reproduciendo...');
                this.play();
            },
            
            play() {
                console.log('üéµ Intentando reproducir m√∫sica...', {
                    soundEnabled,
                    hasAudio: !!this.audio,
                    isPlaying: this.isPlaying
                });
                
                const settings = getSettings();
                if (!settings.musicEnabled) {
                    console.log('üîá M√∫sica de fondo deshabilitada');
                    return;
                }
                
                if (!this.audio) {
                    console.log('üéµ Audio no inicializado, reinicializando...');
                    this.init();
                }
                
                if (this.audio && !this.isPlaying) {
                    this.audio.play().then(() => {
                        this.isPlaying = true;
                        console.log('üéµ M√∫sica de fondo iniciada exitosamente');
                    }).catch(e => {
                        console.log('üéµ No se pudo reproducir m√∫sica de fondo:', e);
                        // Intentar de nuevo despu√©s de un delay
                        setTimeout(() => {
                            console.log('üéµ Reintentando reproducir m√∫sica...');
                            this.audio.play().then(() => {
                                this.isPlaying = true;
                                console.log('üéµ M√∫sica de fondo iniciada en segundo intento');
                            }).catch(e2 => {
                                console.log('üéµ Segundo intento fall√≥:', e2);
                            });
                        }, 1000);
                    });
                } else if (this.isPlaying) {
                    console.log('üéµ M√∫sica ya est√° reproduci√©ndose');
                }
            },
            
            pause() {
                if (this.audio && this.isPlaying) {
                    this.audio.pause();
                    this.isPlaying = false;
                    console.log('üéµ M√∫sica de fondo pausada');
                }
            },
            
            stop() {
                if (this.audio) {
                    this.audio.pause();
                    this.audio.currentTime = 0;
                    this.isPlaying = false;
                    console.log('üéµ M√∫sica de fondo detenida');
                }
            }
        };
            
        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar AndroidInterface
            console.log('üîç AndroidInterface disponible:', !!window.AndroidInterface);
            console.log('üîç AndroidInterface.saveGameProgress disponible:', !!(window.AndroidInterface && window.AndroidInterface.saveGameProgress));
            
            // Cargar configuraciones guardadas
            loadSettings();
            
            // Inicializar indicador de conexi√≥n
            updateConnectionIndicator();
            
            // Cargar nick del usuario
            window.loadUserNick();
            
            // Cargar progreso del juego (desde localStorage - instant√°neo)
            loadGameProgress();
            
            // Inicializar sistemas
            LifeSystem.init();
            CoinSystem.init();
            backgroundMusic.init();
            
            // Iniciar juego inmediatamente
            initGame();
            
            // Solicitar datos de Firebase si hay usuario logueado
            const user = localStorage.getItem('user');
            if (user && window.AndroidInterface && window.AndroidInterface.getUserProgress) {
                const userData = JSON.parse(user);
                console.log('üîÑ Solicitando datos de Firebase al inicio para usuario:', userData.email);
                
                // Activar pantalla de carga
                LoadingSystem.expectFirebaseData();
                
                const modes = ['normal', 'beginner', 'extreme'];
                modes.forEach(mode => {
                    window.AndroidInterface.getUserProgress(userData.uid, mode);
                });
            } else {
                // No hay usuario logueado (invitado) - ocultar pantalla de carga
                console.log('üë§ No hay usuario logueado, ocultando pantalla de carga');
                LoadingSystem.hideLoading();
            }
            
            // Iniciar sincronizaci√≥n peri√≥dica en background
            SyncSystem.startPeriodicSync();
            
            // Intentar iniciar m√∫sica de fondo autom√°ticamente
            setTimeout(() => {
                backgroundMusic.play();
            }, 1000);
            
            // Iniciar m√∫sica en el primer clic del usuario
            let musicStarted = false;
            document.addEventListener('click', () => {
                if (!musicStarted && soundEnabled) {
                    musicStarted = true;
                    backgroundMusic.play();
                    console.log('üéµ M√∫sica iniciada en primer clic del usuario');
                }
            }, { once: true });
            
            // Verificar si la m√∫sica se inici√≥ correctamente
            setTimeout(() => {
                if (!backgroundMusic.isPlaying && soundEnabled) {
                    console.log('üéµ M√∫sica no se inici√≥ autom√°ticamente, se iniciar√° en el primer clic');
                }
            }, 3000);
            
            // Sistema de monedas simplificado (solo por modo)
            
            // Listener para pausar m√∫sica cuando se minimiza la app
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    backgroundMusic.pause();
                } else {
                    // Reanudar m√∫sica si est√° habilitada
                    if (soundEnabled) {
                        backgroundMusic.play();
                    }
                }
            });
            
            // Listener para cerrar dropdown al hacer clic fuera
            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('modeDropdown');
                const pill = document.getElementById('modePill');
                
                if (dropdown && pill && dropdown.classList.contains('open')) {
                    // Si el clic no es en el pill ni en el dropdown, cerrar
                    if (!pill.contains(event.target) && !dropdown.contains(event.target)) {
                        dropdown.classList.remove('open');
                        pill.classList.remove('open');
                    }
                }
            });
            
            // Actualizar timer de vida cada segundo
            setInterval(() => {
                LifeSystem.updateDisplay();
            }, 1000);
            
            updateModeInSettings();
            initGame();
        });
    </script>

    <!-- ===== MODAL AYUDA DE MODOS ===== -->
    <div id="help-modal" class="modal-overlay hidden">
      <div class="modal-backdrop" onclick="closeHelpModal()"></div>
      
      <div class="help-modal-box">
        <!-- Header -->
        <div class="help-modal-header">
          <div class="header-left">
            <div class="header-icon">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"/>
                <path d="M6 9H4.5a1 1 0 0 1 0-5H6"/>
                <path d="M18 9h1.5a1 1 0 0 0 0-5H18"/>
                <path d="M6 15H4.5a1 1 0 0 0 0 5H6"/>
                <path d="M18 15h1.5a1 1 0 0 1 0 5H18"/>
                <circle cx="9" cy="9" r="1"/>
                <circle cx="15" cy="9" r="1"/>
              </svg>
            </div>
            <h2 class="header-title">Modos de Juego</h2>
          </div>
          <button class="btn-close" onclick="closeHelpModal()">‚úï</button>
        </div>
        
        <!-- Content -->
        <div class="help-modal-content">
          
          <!-- MODOS -->
          <div class="help-section">
            <h3 class="help-section-title">Modos Disponibles</h3>
            
            <div class="mode-help-item">
              <div class="mode-help-icon">
                <img src="relax.png" alt="Relax" class="help-mode-icon">
              </div>
              <div class="mode-help-text">
                <h3>Relax (Principiante)</h3>
                <p>¬°Perfecto para empezar! Sin prisa, sin presi√≥n. Solo t√∫, las cartas y tu memoria. Ideal para relajarte y mejorar paso a paso.</p>
              </div>
            </div>
            
            <div class="mode-help-item">
              <div class="mode-help-icon">
                <img src="normal.png" alt="Normal" class="help-mode-icon">
              </div>
              <div class="mode-help-text">
                <h3>Normal</h3>
                <p>El equilibrio perfecto. Tiempo limitado y mec√°nicas especiales que van apareciendo. ¬°Para cuando ya tienes experiencia!</p>
              </div>
            </div>
            
            <div class="mode-help-item">
              <div class="mode-help-icon">
                <img src="extremo.png" alt="Extremo" class="help-mode-icon">
              </div>
              <div class="mode-help-text">
                <h3>Extremo</h3>
                <p>¬°No te conf√≠es! Niveles casi imposibles desde el primer momento. Solo para verdaderos maestros de la memoria. ¬øTe atreves?</p>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <!-- ===== MODAL DE CONFIRMACI√ìN ===== -->
    <div id="confirm-modal" class="modal-overlay hidden">
      <div class="modal-backdrop" onclick="closeConfirmModal()"></div>
      
      <div class="confirm-modal-box">
        <!-- Header -->
        <div class="confirm-modal-header">
          <div class="header-left">
            <div class="header-icon">
              <span class="icon">‚ö†Ô∏è</span>
            </div>
            <h2 class="header-title" id="confirm-title">Confirmar</h2>
          </div>
        </div>
        
        <!-- Content -->
        <div class="confirm-modal-content">
          <p class="confirm-message" id="confirm-message">¬øEst√°s seguro?</p>
          
          <div class="confirm-buttons">
            <button class="btn-cancel" id="cancel-btn">Cancelar</button>
            <button class="btn-confirm" id="confirm-btn">Confirmar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== MODAL DE ALERTA ===== -->
    <div id="alert-modal" class="modal-overlay hidden">
      <div class="modal-backdrop" onclick="closeAlertModal()"></div>
      
      <div class="alert-modal-box">
        <!-- Header -->
        <div class="alert-modal-header">
          <div class="header-left">
            <div class="header-icon">
              <span class="icon">‚ÑπÔ∏è</span>
            </div>
            <h2 class="header-title" id="alert-title">Informaci√≥n</h2>
          </div>
        </div>
        
        <!-- Content -->
        <div class="alert-modal-content">
          <p class="alert-message" id="alert-message">Mensaje</p>
          
          <div class="alert-buttons">
            <button class="btn-ok" id="alert-ok-btn">Aceptar</button>
          </div>
        </div>
      </div>
    </div>
</body>
</html>
