<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoFlip - Juego</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, sans-serif;
            color: #e5e7eb;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 0.5rem;
            margin: 0;
            padding: 0;
        }
        
        /* Contenedor principal - EXACTO como tu dise√±o */
        .game-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 0.0rem 0.4rem 0.2rem 0.4rem;
        }
        
        .game-wrapper {
            max-width: 1024px;
            margin: 0 auto;
            width: 100%;
            max-height: 100%;
        }
        
        /* Fila 1: Logo centrado + controles */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .header-spacer {
            width: 4rem;
        }

        /* ===== SELECTOR DE MODO BONITO ===== */
        .mode-selector-header {
            position: relative;
            z-index: 20;
            margin-top: 0.5rem;
        }

        .mode-pill {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid #2fdde6;
            border-radius: 999px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .mode-pill.beginner {
            background: rgba(250, 204, 21, 0.3);
            border-color: #facc15;
        }
        
        .mode-pill.normal {
            background: rgba(59, 130, 246, 0.3);
            border-color: #2fdde6;
        }
        
        .mode-pill.extreme {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }

        .mode-pill:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .mode-pill.active {
            background: linear-gradient(135deg, #9333ea, #7e22ce);
            border-color: #a855f7;
        }

        .mode-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .mode-text {
            font-size: 12px;
            font-weight: 600;
        }

        .mode-arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .mode-pill.open .mode-arrow {
            transform: rotate(180deg);
        }

        /* ===== DROPDOWN DE MODOS ===== */
        .mode-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: linear-gradient(135deg, #1e293b, #581c87);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 30;
        }

        .mode-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .mode-dropdown-title {
            padding: 8px 12px 6px 12px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 4px;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .mode-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mode-option.active {
            background: rgba(59, 130, 246, 0.3);
            color: #2fdde6;
        }
        
        .mode-option.active.beginner {
            background: rgba(250, 204, 21, 0.3);
            color: #facc15;
        }
        
        .mode-option.active.normal {
            background: rgba(59, 130, 246, 0.3);
            color: #2fdde6;
        }
        
        .mode-option.active.extreme {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .mode-option-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        .mode-option-text {
            font-size: 12px;
        }
        
        .logo {
            width: 8rem;
            height: 8rem;
            object-fit: contain;
            transform: translateY(-10px);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .control-btn {
            padding: 0.5rem;
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            color: white;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Fila 2: Stats (vidas y monedas) */
        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: -4rem;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 2.5rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .user-nick {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
            color: rgb(58, 225, 241);
            margin-top: 2px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            align-self: flex-end;
            transform: translateY(10px);
        }
        
        .life-timer {
            margin-left: 0.5rem;
            font-size: 0.625rem;
            color: #9ca3af;
        }
        
        /* Header del juego */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .level-info h2 {
            font-size: 1.125rem;
            font-weight: bold;
            margin: 0 0 0 1rem;
            height: 2rem;
            display: flex;
            align-items: center;
        }
        
        .level-info h2::after {
            content: " ";
        }
        
        .mode-indicator {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .time-stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .time-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .pause-btn {
            height: 2rem;
            display: flex;
            align-items: center;
            margin-right: 1rem;
        }
        
        .pause-btn .control-btn {
            height: 2rem;
            width: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .header-center {
            text-align: center;
        }
        
        .level-info {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .stats {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 20px;
        }
        
        .icon {
            width: 20px;
            height: 20px;
        }
        
        .lucide {
            width: 20px;
            height: 20px;
            color: #e5e7eb;
        }
        
        /* √Årea de juego */
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            flex: 1;
            width: 100%;
        }
        
        /* Grid de cartas - 4x6 = 24 slots SIEMPRE */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 80px); /* ‚Üê TAMA√ëO FIJO: 80px cada columna */
            grid-template-rows: repeat(6, 80px);    /* ‚Üê TAMA√ëO FIJO: 80px cada fila */
            gap: 12px;
            justify-content: center;
            align-content: center;
            transition: all 0.5s ease;
        }
        
        /* Responsive para tablet */
        @media (min-width: 768px) {
            .cards-grid {
                gap: 12px;
                max-width: 80vw;
                max-height: 65vh;
            }
        }
        
        /* Responsive para m√≥vil peque√±o */
        @media (max-width: 480px) {
            .cards-grid {
                grid-template-columns: repeat(4, 70px); /* ‚Üê 70px para m√≥viles peque√±os */
                grid-template-rows: repeat(6, 70px);    /* ‚Üê 70px para m√≥viles peque√±os */
                gap: 8px;
            }
            
            .card,
            .card.empty-slot {
                width: 70px !important;   /* ‚Üê 70px para m√≥viles peque√±os */
                height: 70px !important;  /* ‚Üê 70px para m√≥viles peque√±os */
            }
        }
        
        .cards-grid-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 98vw;
        }
        
        /* Carta - TAMA√ëO FIJO como tu dise√±o */
        .card {
            width: 80px !important;   /* ‚Üê SIEMPRE 80px */
            height: 80px !important;  /* ‚Üê SIEMPRE 80px */
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-radius: 14px;
        }
        
        /* Responsive para m√≥viles peque√±os */
        @media (max-width: 480px) {
            .card {
                width: 70px !important;   /* ‚Üê 70px para m√≥viles peque√±os */
                height: 70px !important;  /* ‚Üê 70px para m√≥viles peque√±os */
            }
        }
        
        /* Slot vac√≠o */
        .card.empty-slot {
            width: 80px !important;   /* ‚Üê SIEMPRE 80px */
            height: 80px !important;  /* ‚Üê SIEMPRE 80px */
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
        }
        
        .card:hover {
            transform: scale(1.02);
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        .card:disabled {
            cursor: not-allowed;
        }
        
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
        }
        
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        
        .card-back, .card-front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            top: 0;
            left: 0;
            border-radius: 14px;
            display: grid;
            place-items: center;
        }
        
        .card-back {
            background: linear-gradient(135deg, rgba(99,102,241,.3), rgba(217,70,239,.3), rgba(14,165,233,.3));
            border: 1px solid rgba(255,255,255,.2);
            font-size: 28px;
        }
        
        .card-front {
            background: transparent;
            color: #0f172a;
            font-size: 48px;
            transform: rotateY(180deg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card.matched {
            background: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            border: 2px solid #10b981;
        }
        
        .card.wrong {
            background: rgba(239, 68, 68, 0.2);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            border: 2px solid #ef4444;
        }
        
        /* ===== ESTILOS DE MEC√ÅNICAS ===== */
        
        /* üëª GHOST */
        .card.ghost {
            opacity: 0.7;
            animation: pulse 2s infinite;
        }
        
        .card.ghost.invisible {
            opacity: 0 !important;
            pointer-events: none;
        }
        
        .ghost-emoji {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            display: none; /* Inicialmente oculto */
            align-items: center;
            justify-content: center;
            font-size: 48px;
            animation: pulse 2s infinite;
            pointer-events: none;
            z-index: 100 !important; /* Z-index muy alto para estar por encima de todo */
            background: rgba(0, 0, 0, 0.8) !important;
            border-radius: 14px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 1);
            color: white !important;
            font-weight: bold;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        /* üí® FOG */
        .card.fog {
            transition: filter 0.3s ease, opacity 0.3s ease;
        }
        
        /* üí£ BOMB */
        .bomb-level-0 {
            border: 2px solid #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }
        
        .bomb-level-1 {
            border: 2px solid #f97316;
            background: rgba(249, 115, 22, 0.1);
        }
        
        .bomb-level-2 {
            border: 2px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
            animation: bomb-pulse 0.5s infinite;
        }
        
        .card.exploded {
            animation: explode 0.3s ease-out forwards;
        }
        
        /* ‚ùÑÔ∏è FROZEN */
        .card.frozen {
            opacity: 0.8;
            cursor: not-allowed !important;
            pointer-events: none;
            border: 4px solid #60a5fa;
            background: rgba(96, 165, 250, 0.2);
            animation: frozen-pulse 1s infinite;
        }
        
        .ice-emoji {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            pointer-events: none;
            z-index: 20;
            animation: pulse 1s infinite;
        }
        
        /* üîÑ ROTATION */
        .card {
            transition: transform 0.3s ease-in-out;
        }
        
        /* ü¶é CHAMELEON */
        .cards-grid.filter-green {
            filter: hue-rotate(120deg) saturate(150%);
            transition: filter 0.5s;
        }
        
        .cards-grid.filter-red {
            filter: hue-rotate(0deg) saturate(150%);
            transition: filter 0.5s;
        }
        
        .cards-grid.filter-blue {
            filter: hue-rotate(240deg) saturate(150%);
            transition: filter 0.5s;
        }
        
        .cards-grid.filter-yellow {
            filter: hue-rotate(60deg) saturate(150%);
            transition: filter 0.5s;
        }
        
        /* üëÅÔ∏è PEEKED_CARD */
        .card.auto-peeked {
            border: 2px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
        
        /* ===== ANIMACIONES ===== */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
        
        @keyframes bomb-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes explode {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
        
        @keyframes frozen-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(96, 165, 250, 0);
            }
        }
        
        /* ===== MODAL DE ANUNCIO DE MEC√ÅNICAS ===== */
        
        /* Overlay transparente (se ven las cartas detr√°s) */
        .mechanic-intro-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* NO bloquea clics en el fondo */
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        
        .mechanic-intro-overlay.show {
            display: flex;
            opacity: 1;
        }
        
        @keyframes mechanic-fade-in {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* Caja transparente con blur */
        .mechanic-intro-box {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.15),
                rgba(255, 255, 255, 0.1)
            );
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            margin: 0 16px;
        }
        
        /* T√≠tulo */
        .mechanic-intro-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-align: center;
            margin: 0 0 16px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        /* Lista de mec√°nicas */
        .mechanic-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        /* Cada mec√°nica */
        .mechanic-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(147, 51, 234, 0.5); /* Morado semi-transparente */
            border-radius: 8px;
            padding: 12px;
            animation: mechanic-slide-in 0.3s ease-out backwards;
        }
        
        /* Aparecen progresivamente */
        .mechanic-item:nth-child(1) { animation-delay: 0s; }
        .mechanic-item:nth-child(2) { animation-delay: 0.2s; }
        .mechanic-item:nth-child(3) { animation-delay: 0.4s; }
        .mechanic-item:nth-child(4) { animation-delay: 0.6s; }
        
        @keyframes mechanic-slide-in {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .mechanic-icon {
            font-size: 24px;
        }
        
        .mechanic-name {
            color: white;
            font-weight: 500;
            font-size: 16px;
        }
        
        /* Footer */
        .mechanic-intro-footer {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            animation: footer-fade 0.3s ease-out;
            animation-delay: 0.5s;
            animation-fill-mode: backwards;
        }
        
        @keyframes footer-fade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .card:not(:disabled):hover {
            transform: scale(1.02);
        }
        
        .card:not(:disabled):active {
            transform: scale(0.98);
        }
        
        /* Sistema de part√≠culas */
        .particle {
            position: absolute;
            font-size: 24px;
            pointer-events: none;
            animation: particle-float 1s ease-out forwards;
        }
        
        @keyframes particle-float {
            0% {
                transform: translate(-50%, -50%) translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) 
                           translate(var(--tx), var(--ty)) 
                           scale(0);
                opacity: 0;
            }
        }
        
        /* Sistema de monedas voladoras */
        .flying-coin {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
            font-size: 24px;
            animation: flyToTarget 1s ease-out forwards;
        }
        
        @keyframes flyToTarget {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--target-x), var(--target-y)) scale(0.5);
                opacity: 0;
            }
        }
        
        .card-back img {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
            display: block;
            user-select: none;
        }
        
        .card-front img {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
            display: block;
            user-select: none;
        }
        
        /* Asegurar que las cartas con logo tengan el mismo tama√±o que los slots vac√≠os */
        .card {
            width: 100% !important;
            height: 100% !important;
            aspect-ratio: 1/1 !important;
        }
        
        /* Informaci√≥n de Mec√°nica */
        .mechanic-info {
            margin-top: 12px;
            display: flex;
            justify-content: center;
        }
        
        .mechanic-content {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
        }
        
        .mechanic-icon {
            font-size: 18px;
        }
        
        .mechanic-text h3 {
            color: white;
            font-weight: 600;
            font-size: 12px;
            margin: 0;
        }
        
        .mechanic-text p {
            color: #d1d5db;
            font-size: 12px;
            margin: 0;
            line-height: 1.2;
        }
        
        .mechanic-help {
            margin-left: 8px;
            padding: 4px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mechanic-help:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Botones */
        .game-buttons {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            z-index: 100;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Modal de nivel completado */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        
        .settings-section {
            margin: 1rem 0;
            text-align: left;
        }
        
        .settings-section label {
            display: block;
            margin: 0.75rem 0;
            color: #333;
            font-size: 0.9rem;
        }
        
        .settings-section select {
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            color: #333;
            padding: 0.5rem;
            margin-left: 0.5rem;
            font-size: 0.9rem;
            width: 120px;
        }
        
        .modal h2 {
            color: #333;
            margin-bottom: 1rem;
        }
        
        .modal p {
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .card {
                width: 50px;
                height: 50px;
            }
            
            .card-content {
                font-size: 1.2rem;
            }
        }

        /* ===== MODALES - CSS COMPLETO ===== */
        
        /* ===== OVERLAY GENERAL ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        /* ===== CAJA DEL MODAL ===== */
        .modal-box {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 400px;
            margin: 0 16px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* ===== MODAL VICTORIA ===== */
        .modal-victory {
            background: linear-gradient(135deg, #1e293b, #581c87, #1e293b);
            margin-top: 2rem; /* M√°s abajo para no tapar el logo */
            margin-right: 1rem; /* M√°s a la derecha */
        }

        /* ===== MODAL DERROTA ===== */
        .modal-defeat {
            background: linear-gradient(135deg, #1e293b, #7f1d1d, #1e293b);
        }

        /* ===== MODAL SIN VIDAS ===== */
        .modal-no-lives {
            background: linear-gradient(135deg, #1e293b, #7f1d1d, #1e293b);
        }

        /* ===== HEADER ===== */
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-no-lives .modal-header {
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icon {
            padding: 4px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        .header-icon .icon {
            font-size: 16px;
        }

        .header-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
            margin: 0;
            text-align: center;
            width: 100%;
        }

        .modal-defeat .header-title {
            font-size: 16px;
        }

        .btn-close {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ===== CONTENT ===== */
        .modal-content {
            padding: 16px;
            text-align: center;
        }

        .modal-victory .modal-content {
            padding: 16px;
        }

        .modal-defeat .modal-content {
            padding: 12px;
        }

        /* ===== LOTTIE (SOLO VICTORIA) ===== */
        .lottie-container {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
            padding: 0;
        }

        #lottie-victory {
            width: 160px;
            height: 160px;
        }

        /* ===== CORAZ√ìN ROTO (DERROTA Y SIN VIDAS) ===== */
        .broken-heart-container {
            display: flex;
            justify-content: center;
            margin-bottom: 12px;
        }

        .broken-heart {
            font-size: 60px;
            animation: shake 0.5s ease-in-out infinite alternate;
            filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.5));
        }

        @keyframes shake {
            0% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-4px) rotate(-2deg); }
            50% { transform: translateX(4px) rotate(2deg); }
            75% { transform: translateX(-2px) rotate(-1deg); }
            100% { transform: translateX(2px) rotate(1deg); }
        }

        /* ===== INFORMACI√ìN ===== */
        .info-container {
            margin-bottom: 16px;
        }

        .info-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .modal-defeat .info-text {
            font-size: 14px;
            color: #d1d5db;
        }

        /* ===== ESTAD√çSTICAS ===== */
        .stats-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .stat-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: #d1d5db;
        }

        .stat-icon {
            font-size: 16px;
        }

        .stat-coins {
            font-size: 18px;
        }

        .stat-coins strong {
            color: #fbbf24;
            font-weight: bold;
        }

        .time-limit {
            color: #60a5fa;
        }

        .coins {
            color: #fbbf24;
        }

        .lives {
            color: #f87171;
        }

        /* ===== TIMER REGENERACI√ìN (SIN VIDAS) ===== */
        .regen-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
        }

        .regen-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .regen-icon {
            font-size: 18px;
        }

        .regen-label {
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .regen-timer {
            font-size: 24px;
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 4px;
        }

        .regen-info {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
        }

        /* ===== BOTONES ===== */
        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .modal-no-lives .modal-actions {
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-next-level {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            font-weight: 900;
            padding: 16px 32px;
            font-size: 20px;
            text-align: center;
            width: 100%;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .btn-next-level:hover {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn-retry {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-retry:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-watch-ad {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-watch-ad:hover {
            background: linear-gradient(135deg, #059669, #047857);
        }

        /* ===== MODAL CONFIGURACI√ìN ===== */
        .settings-modal-box {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 500px;
            margin: 0 16px;
            background: linear-gradient(135deg, #1e293b, #581c87, #1e293b);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* ===== HEADER CONFIGURACI√ìN ===== */
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-header .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-header .header-icon {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
        }

        .settings-header .header-icon .icon {
            font-size: 24px;
        }

        .settings-header .header-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 0;
        }

        .settings-header .btn-close {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .settings-header .btn-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ===== CONTENT CONFIGURACI√ìN ===== */
        .settings-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* ===== SECCI√ìN ===== */
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        /* ===== ITEM DE CONFIGURACI√ìN (AUDIO/VIBRACI√ìN) ===== */
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .setting-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setting-icon {
            font-size: 24px;
        }

        .setting-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .setting-name {
            font-size: 14px;
            font-weight: 500;
            color: white;
            margin: 0;
        }

        .setting-desc {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
        }

        /* ===== BOT√ìN TOGGLE (ACTIVAR/DESACTIVAR) ===== */
        .setting-toggle {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid;
        }

        .setting-toggle.active {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .setting-toggle.active:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .setting-toggle:not(.active) {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .setting-toggle:not(.active):hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* ===== MODOS DE JUEGO ===== */
        .game-modes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mode-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .mode-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Modo activo - Principiante (verde) */
        .mode-button.active#mode-beginner {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
            color: #4ade80;
        }

        /* Modo activo - Normal (azul) */
        .mode-button.active#mode-normal {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }

        /* Modo activo - Extremo (rojo) */
        .mode-button.active#mode-extreme {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #f87171;
        }

        .mode-icon {
            font-size: 20px;
        }

        .mode-text {
            flex: 1;
        }

        .mode-name {
            font-size: 14px;
            font-weight: 500;
            margin: 0;
        }

        .mode-desc {
            font-size: 12px;
            opacity: 0.7;
            margin: 0;
        }

        .mode-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: transparent;
        }

        .mode-indicator.active {
            background: currentColor;
        }

        /* ===== CUENTA ===== */
        .account-info {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin: 0 0 8px 0;
        }

        /* Bot√≥n Google */
        .btn-google {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 999px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(4px);
        }

        .btn-google:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .google-icon {
            width: 16px;
            height: 16px;
        }

        /* Usuario logueado */
        .user-info-box {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .user-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin: 0 0 4px 0;
        }

        .user-email {
            font-size: 14px;
            color: white;
            font-weight: 500;
            margin: 0;
        }

        /* Bot√≥n cerrar sesi√≥n */
        .btn-logout {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: rgba(249, 115, 22, 0.2);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 12px;
            color: #fb923c;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .btn-logout:hover {
            background: rgba(249, 115, 22, 0.3);
        }

        /* Bot√≥n eliminar cuenta */
        .btn-delete-account {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            color: #f87171;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-delete-account:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .btn-icon {
            font-size: 16px;
        }

        /* ===== FOOTER ===== */
        .settings-footer {
            padding: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .settings-footer p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
        }

        /* ===== MODAL ANUNCIO DE MEC√ÅNICAS ===== */
        .mechanic-intro-overlay {
            position: fixed;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* ‚Üê NO bloquea interacci√≥n */
            animation: mechanic-fade-in 0.5s ease-out;
        }

        .mechanic-intro-overlay.hidden {
            display: none;
        }

        @keyframes mechanic-fade-in {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* ===== CAJA TRANSPARENTE CON BLUR ===== */
        .mechanic-intro-box {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.15),
                rgba(255, 255, 255, 0.1)
            );
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 24px;
            max-width: 400px;
            width: 100%;
            margin: 0 16px;
        }

        /* ===== CONTENIDO ===== */
        .mechanic-intro-content {
            text-align: center;
        }

        /* ===== T√çTULO ===== */
        .mechanic-intro-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
            margin: 0 0 16px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* ===== LISTA DE MEC√ÅNICAS ===== */
        .mechanic-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        /* ===== CADA MEC√ÅNICA ===== */
        .mechanic-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: rgba(147, 51, 234, 0.5); /* purple-600/50 */
            border-radius: 8px;
            padding: 12px;
            animation: mechanic-slide-in 0.3s ease-out backwards;
        }

        /* Cada mec√°nica aparece con delay progresivo */
        .mechanic-item:nth-child(1) { animation-delay: 0s; }
        .mechanic-item:nth-child(2) { animation-delay: 0.2s; }
        .mechanic-item:nth-child(3) { animation-delay: 0.4s; }
        .mechanic-item:nth-child(4) { animation-delay: 0.6s; }
        .mechanic-item:nth-child(5) { animation-delay: 0.8s; }

        @keyframes mechanic-slide-in {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ===== ICONO EMOJI ===== */
        .mechanic-icon {
            font-size: 24px;
            line-height: 1;
        }

        /* ===== NOMBRE DE MEC√ÅNICA ===== */
        .mechanic-name {
            color: white;
            font-weight: 500;
            font-size: 16px;
            text-transform: capitalize;
        }

        /* ===== TEXTO FOOTER ===== */
        .mechanic-intro-footer {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            animation: mechanic-footer-fade 0.3s ease-out;
            animation-delay: 0.5s;
            animation-fill-mode: backwards;
        }

        @keyframes mechanic-footer-fade {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* ===== HELPERS ===== */
        .hidden {
            display: none;
        }

        /* ===== MODAL RANKING ===== */
        /* ===== MODAL DE AYUDA DE MEC√ÅNICAS ===== */
        .mechanic-help-box {
            position: relative;
            z-index: 10;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            margin: 0 16px;
        }

        .mechanic-help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .mechanic-help-header h2 {
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .mechanic-help-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .mechanic-help-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
        }

        .mechanic-help-header-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .mechanic-help-icon {
            font-size: 24px;
        }

        .mechanic-help-name {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .mechanic-help-desc {
            color: #d1d5db;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }

        .ranking-modal-box {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            margin: 0 16px;
            background: linear-gradient(135deg, #1e293b, #581c87, #1e293b);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        .ranking-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icon {
            padding: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 20px;
        }

        .header-icon.trophy {
            color: #fbbf24;
        }

        .ranking-header h2 {
            font-size: 20px;
            font-weight: bold;
            color: white;
            margin: 0;
        }

        .btn-close {
            padding: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ===== CONTENT ===== */
        .ranking-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .ranking-state {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ===== ESTADO CARGANDO ===== */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px 0;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(147, 51, 234, 0.3);
            border-top-color: #9333ea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== ESTADO ERROR ===== */
        .error-message {
            color: #f87171;
            font-size: 14px;
            text-align: center;
            margin-bottom: 16px;
        }

        .btn-retry {
            padding: 8px 16px;
            background: #9333ea;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-retry:hover {
            background: #7e22ce;
        }

        /* ===== ESTADO √âXITO ===== */
        .ranking-trophy-badge {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }

        .trophy-badge {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            font-size: 32px;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }

        .ranking-title {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin: 0 0 8px 0;
        }

        .ranking-subtitle {
            color: #d1d5db;
            font-size: 14px;
            text-align: center;
            margin: 0 0 24px 0;
        }

        /* ===== TABLA DE RANKING ===== */
        .ranking-table {
            width: 100%;
            margin-bottom: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ranking-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table thead {
            background: rgba(147, 51, 234, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ranking-table th {
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
        }

        .ranking-table th:first-child {
            text-align: center;
            width: 60px;
        }

        .ranking-table th:last-child {
            text-align: right;
        }

        .ranking-table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .ranking-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .ranking-table td {
            padding: 12px 8px;
            color: white;
            font-size: 14px;
        }

        .position {
            text-align: center;
            font-weight: bold;
        }

        /* Top 3 con colores */
        .rank-1 .position { color: #fbbf24; } /* Oro */
        .rank-2 .position { color: #d1d5db; } /* Plata */
        .rank-3 .position { color: #cd7f32; } /* Bronce */

        .player {
            font-weight: 500;
        }

        .score {
            text-align: right;
            font-weight: bold;
            color: #60a5fa;
        }

        /* ===== BOT√ìN ABRIR RANKING NATIVO ===== */
        .btn-open-native-ranking {
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            border: none;
            border-radius: 999px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-open-native-ranking:hover {
            background: linear-gradient(135deg, #2563eb, #7e22ce);
            transform: scale(1.02);
        }

        /* ===== FOOTER ===== */
        .ranking-footer {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            text-align: center;
        }

        .ranking-footer p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
        }

        /* ===== SCROLLBAR RANKING ===== */
        .ranking-content::-webkit-scrollbar {
            width: 8px;
        }

        .ranking-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .ranking-content::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.5);
            border-radius: 4px;
        }

        .ranking-content::-webkit-scrollbar-thumb:hover {
            background: rgba(147, 51, 234, 0.7);
        }

        /* ===== MEC√ÅNICAS CSS ===== */
        
        /* ===== FOG ===== */
        .card.fog {
            filter: blur(8px);
            opacity: 0.5;
        }

        /* ===== GHOST ===== */
        .card.invisible {
            opacity: 0 !important;
            pointer-events: none;
        }

        /* ===== BOMB ===== */
        .card.bomb-level-0 {
            border: 2px solid #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .card.bomb-level-1 {
            border: 2px solid #f97316;
            background: rgba(249, 115, 22, 0.1);
        }

        .card.bomb-level-2 {
            border: 2px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .card.exploded {
            animation: explode 0.3s ease-out;
        }

        @keyframes explode {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        /* ===== FROZEN ===== */
        .card.frozen {
            opacity: 0.8;
            cursor: not-allowed !important;
            pointer-events: none;
            border: 4px solid #60a5fa;
            background: rgba(96, 165, 250, 0.2);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(96, 165, 250, 0);
            }
        }

        /* ===== ROTATION ===== */
        .card.rotation {
            transition: transform 0.3s ease-in-out;
        }

        /* ===== CHAMELEON (aplicar al grid) ===== */
        .cards-grid.filter-green {
            filter: hue-rotate(120deg) saturate(150%);
        }

        .cards-grid.filter-red {
            filter: hue-rotate(0deg) saturate(150%);
        }

        .cards-grid.filter-blue {
            filter: hue-rotate(240deg) saturate(150%);
        }

        .cards-grid.filter-yellow {
            filter: hue-rotate(60deg) saturate(150%);
        }

        /* ===== DARKNESS ===== */
        /* Se aplica din√°micamente con JavaScript */
    </style>
</head>
<body>
    <!-- Fondo forzado -->
    <div style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(135deg, #312e81, #581c87, #0f172a); z-index: -1;"></div>
    
    <!-- Contenedor principal - EXACTO como tu dise√±o -->
    <div class="game-content">
        <div class="game-wrapper">
                <!-- Fila 1: Logo centrado + controles -->
                <div class="header-row">
                    <!-- Selector de modo bonito -->
                    <div class="mode-selector-header">
                        <button class="mode-pill" id="modePill" onclick="toggleModeSelector()">
                            <img class="mode-icon" id="modeIcon" src="relax.png" alt="Relax">
                            <span class="mode-text" id="modeText">Relax</span>
                            <span class="mode-arrow">‚ñº</span>
                        </button>
                        
                        <!-- Dropdown de modos -->
                        <div class="mode-dropdown" id="modeDropdown">
                            <div class="mode-dropdown-title">Modo de juego</div>
                            <button class="mode-option" onclick="changeMode('beginner')">
                                <img class="mode-option-icon" src="relax.png" alt="Relax">
                                <span class="mode-option-text">Relax</span>
                            </button>
                            <button class="mode-option" onclick="changeMode('normal')">
                                <img class="mode-option-icon" src="normal.png" alt="Normal">
                                <span class="mode-option-text">Normal</span>
                            </button>
                            <button class="mode-option" onclick="changeMode('extreme')">
                                <img class="mode-option-icon" src="extremo.png" alt="Extremo">
                                <span class="mode-option-text">Extremo</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Logo centrado -->
                    <img src="logo.png" alt="MemoFlip" class="logo" onclick="goToMainMenu()" style="cursor: pointer;">
                    
                    <!-- Controles a la derecha -->
                    <div class="header-controls">
                        <button class="control-btn" onclick="showRanking()" title="Ranking">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy w-5 h-5 text-white" aria-hidden="true">
                                <path d="M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"></path>
                                <path d="M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"></path>
                                <path d="M18 9h1.5a1 1 0 0 0 0-5H18"></path>
                                <path d="M4 22h16"></path>
                                <path d="M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"></path>
                                <path d="M6 9H4.5a1 1 0 0 1 0-5H6"></path>
                            </svg>
                        </button>
                        
                        <button class="control-btn" onclick="toggleSound()" title="Sonido">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                        </button>
                        
                        <button class="control-btn" onclick="showSettings()" title="Ajustes">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </button>
                        
                    </div>
                </div>
                
                <!-- Fila 2: Coraz√≥n izquierda + monedas derecha -->
                <div class="stats-row">
                    <div class="stat-item">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                        <span id="lives">3</span>
                        <div id="lifeTimer" class="life-timer"></div>
                    </div>
                    
                    <div class="user-nick">
                        <span id="userNick">Usuario</span>
                    </div>
                    
                    <div class="stat-item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coins w-5 h-5 text-white" aria-hidden="true">
                            <circle cx="8" cy="8" r="6"></circle>
                            <path d="M18.09 10.37A6 6 0 1 1 10.34 18"></path>
                            <path d="M7 6h1v4"></path>
                            <path d="m16.71 13.88.7.71-2.82 2.82"></path>
                        </svg>
                        <span id="cards">0</span>
                    </div>
                    
                </div>
                
                <!-- Nivel, tiempo y controles -->
                <div class="game-header">
                    <div class="level-info">
                        <!-- Nivel con espacio -->
                        <h2>Nivel&nbsp;<span id="currentLevel">1</span></h2>
                    </div>
                    
                    <div class="time-stats">
                        <div class="time-item">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            <span id="gameTime">00:00</span>
                        </div>
                        
                        <div class="time-item">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                            <span id="totalFlips">0</span>
                        </div>
                    </div>
                    
                    <!-- Barra de tiempo l√≠mite -->
                    <div id="time-bar-wrapper" class="time-bar-container" style="display: none;">
                        <div class="time-bar" id="time-bar" style="width: 0%;"></div>
                    </div>
                    
                    <div class="pause-btn">
                        <button class="control-btn" onclick="togglePause()" title="Pausa" id="pause-play-btn">
                            <svg class="icon pause-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 4h4v16H6zM14 4h4v16h-4z"/>
                            </svg>
                            <svg class="icon play-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
    
    <!-- √Årea de juego -->
    <div class="game-area">
        <div class="cards-grid-container">
            <div id="cardsGrid" class="cards-grid">
                <!-- Las cartas se generar√°n aqu√≠ -->
            </div>
        </div>
        
        <!-- Informaci√≥n de Mec√°nica -->
        <div id="mechanicInfo" class="mechanic-info">
            <div class="mechanic-content">
                <div class="mechanic-icon">üé¥</div>
                <div class="mechanic-text">
                    <h3>Mec√°nica B√°sica</h3>
                    <p>Encuentra las parejas iguales</p>
                </div>
                <button class="mechanic-help" onclick="showMechanicHelp()">?</button>
            </div>
        </div>
    </div>
    
    
    <!-- ===== MODAL DE VICTORIA ===== -->
    <div id="modal-victory" class="modal-overlay hidden">
        <div class="modal-backdrop"></div>
        
        <div class="modal-box modal-victory">
            <!-- Header -->
            <div class="modal-header">
                <h2 class="header-title">¬°Nivel Superado!</h2>
            </div>
            
            <!-- Content -->
            <div class="modal-content">
                <!-- Animaci√≥n Lottie -->
                <div class="lottie-container">
                    <div id="lottie-victory"></div>
                </div>
                
                <!-- Estad√≠sticas -->
                <div class="stats-container">
                    <div class="stat-row">
                        <span class="stat-text">Tiempo: <strong id="time-played">0:45</strong></span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-text">Giros: <strong id="flips-count">12</strong></span>
                    </div>
                    <div class="stat-row stat-coins">
                        <span class="stat-text"><strong id="coins-earned">+ 20 monedas</strong></span>
                    </div>
                </div>
                
                <!-- Bot√≥n -->
                <div class="modal-actions">
                    <button class="btn btn-next-level" id="btn-next-level">
                        SIGUIENTE NIVEL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL DE DERROTA ===== -->
    <div id="modal-defeat" class="modal-overlay hidden">
        <div class="modal-backdrop"></div>
        
        <div class="modal-box modal-defeat">
            <!-- Header -->
            <div class="modal-header">
                <div class="header-icon">
                    <span class="icon">‚ù§Ô∏è</span>
                </div>
                <h2 class="header-title">¬°Tiempo Agotado!</h2>
            </div>
            
            <!-- Content -->
            <div class="modal-content">
                <!-- Coraz√≥n roto con shake -->
                <div class="broken-heart-container">
                    <div class="broken-heart">üíî</div>
                </div>
                
                <!-- Informaci√≥n -->
                <div class="info-container">
                    <p class="info-text">
                        Se acab√≥ el tiempo para el nivel <strong id="failed-level">1</strong>
                    </p>
                    
                    <!-- Estad√≠sticas -->
                    <div class="stats-container">
                        <div class="stat-row">
                            <span class="stat-icon">‚è∞</span>
                            <span class="stat-text time-limit">Tiempo l√≠mite: <span id="time-limit">1:00</span></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">ü™ô</span>
                            <span class="stat-text coins">Monedas ganadas: <span id="coins-earned-fail">5</span></span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-icon">‚ù§Ô∏è</span>
                            <span class="stat-text lives"><strong>Vidas restantes: <span id="lives-remaining">2</span></strong></span>
                        </div>
                    </div>
                </div>
                
                <!-- Botones -->
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="btn-exit">Salir</button>
                    <button class="btn btn-retry" id="btn-retry">Reintentar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL SIN VIDAS ===== -->
    <div id="modal-no-lives" class="modal-overlay hidden">
        <div class="modal-backdrop"></div>
        
        <div class="modal-box modal-no-lives">
            <!-- Header con bot√≥n cerrar -->
            <div class="modal-header">
                <div class="header-left">
                    <div class="header-icon">
                        <span class="icon">‚ù§Ô∏è</span>
                    </div>
                    <h2 class="header-title">¬°Sin Vidas!</h2>
                </div>
                <button class="btn-close" id="btn-close-no-lives">‚úï</button>
            </div>
            
            <!-- Content -->
            <div class="modal-content">
                <!-- Coraz√≥n roto -->
                <div class="broken-heart-container">
                    <div class="broken-heart">üíî</div>
                </div>
                
                <!-- Informaci√≥n -->
                <div class="info-container">
                    <p class="info-text">
                        Te has quedado sin vidas. Puedes esperar o ver un anuncio.
                    </p>
                    
                    <!-- Timer de regeneraci√≥n -->
                    <div class="regen-box">
                        <div class="regen-header">
                            <span class="regen-icon">‚è∞</span>
                            <span class="regen-label">Pr√≥xima vida en:</span>
                        </div>
                        <div class="regen-timer" id="life-timer">29:59</div>
                        <p class="regen-info">Las vidas se regeneran cada 30 minutos</p>
                    </div>
                </div>
                
                <!-- Bot√≥n -->
                <div class="modal-actions">
                    <button class="btn btn-watch-ad" id="btn-watch-ad">
                        Ver Video
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL DE CONFIGURACI√ìN ===== -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-backdrop" onclick="closeSettingsModal()"></div>
        
        <div class="settings-modal-box">
            <!-- Header -->
            <div class="settings-header">
                <div class="header-left">
                    <div class="header-icon">
                        <span class="icon">‚öôÔ∏è</span>
                    </div>
                    <h2 class="header-title">Configuraci√≥n</h2>
                </div>
                <button class="btn-close" onclick="closeSettingsModal()">‚úï</button>
            </div>
            
            <!-- Content -->
            <div class="settings-content">
                
                <!-- AUDIO -->
                <div class="settings-section">
                    <h3 class="section-title">Audio</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-icon" id="sound-icon">üîä</span>
                            <div class="setting-text">
                                <p class="setting-name" id="sound-name">Sonido Activado</p>
                                <p class="setting-desc" id="sound-desc">M√∫sica y efectos activos</p>
                            </div>
                        </div>
                        <button class="setting-toggle active" id="sound-toggle" onclick="toggleSound()">
                            Desactivar
                        </button>
                    </div>
                </div>
                
                <!-- VIBRACI√ìN -->
                <div class="settings-section">
                    <h3 class="section-title">Vibraci√≥n</h3>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-icon" id="vibration-icon">üì±</span>
                            <div class="setting-text">
                                <p class="setting-name" id="vibration-name">Vibraci√≥n Activada</p>
                                <p class="setting-desc" id="vibration-desc">Vibraci√≥n al tocar cartas</p>
                            </div>
                        </div>
                        <button class="setting-toggle active" id="vibration-toggle" onclick="toggleVibration()">
                            Desactivar
                        </button>
                    </div>
                </div>
                
                
                <!-- CUENTA -->
                <div class="settings-section">
                    <h3 class="section-title">Cuenta</h3>
                    
                    <!-- Usuario NO logueado -->
                    <div id="account-logged-out">
                        <p class="account-info">
                            Inicia sesi√≥n para guardar tu progreso
                        </p>
                        <button class="btn-google" onclick="loginWithGoogleFromGame()">
                            <svg class="google-icon" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Entrar con Google
                        </button>
                    </div>
                    
                    <!-- Usuario logueado -->
                    <div id="account-logged-in" class="hidden">
                        <!-- Email del usuario -->
                        <div class="user-info-box">
                            <p class="user-label">Usuario:</p>
                            <p class="user-email" id="user-email">ejemplo@gmail.com</p>
                        </div>
                        
                        <!-- Bot√≥n cerrar sesi√≥n -->
                        <button class="btn-logout" onclick="logout()">
                            <span class="btn-icon">üö™</span>
                            Cerrar sesi√≥n
                        </button>
                        
                        <!-- Bot√≥n eliminar cuenta -->
                        <button class="btn-delete-account" onclick="deleteAccount()">
                            <span class="btn-icon">üóëÔ∏è</span>
                            Eliminar cuenta
                        </button>
                    </div>
                </div>
                
            </div>
            
            <!-- Footer -->
            <div class="settings-footer">
                <p>MemoFlip v1.0 - Desarrollado con ‚ù§Ô∏è</p>
            </div>
        </div>
    </div>

    <!-- ===== MODAL ANUNCIO DE MEC√ÅNICAS ===== -->
    <div id="mechanic-intro" class="mechanic-intro-overlay hidden">
        <div class="mechanic-intro-box">
            <div class="mechanic-intro-content">
                <!-- T√≠tulo -->
                <h3 class="mechanic-intro-title">¬°Desaf√≠o Especial!</h3>
                
                <!-- Lista de mec√°nicas -->
                <div class="mechanic-list" id="mechanic-list">
                    <!-- Las mec√°nicas se agregan din√°micamente -->
                </div>
                
                <!-- Texto de motivaci√≥n -->
                <div class="mechanic-intro-footer">
                    ¬°Demuestra tu habilidad!
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ranking -->
    <!-- Modal de Ayuda de Mec√°nicas -->
    <div id="mechanic-help-modal" class="modal-overlay hidden">
        <div class="modal-backdrop" onclick="closeMechanicHelp()"></div>
        <div class="mechanic-help-box">
            <div class="mechanic-help-header">
                <h2>Mec√°nicas del Juego</h2>
                <button class="btn-close" onclick="closeMechanicHelp()">‚úï</button>
            </div>
            <div class="mechanic-help-list" id="mechanic-help-list">
                <!-- Se rellena din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Anuncio de Mec√°nicas -->
    <div id="mechanic-intro" class="mechanic-intro-overlay">
        <div class="mechanic-intro-box">
            <h3 class="mechanic-intro-title">¬°Desaf√≠o Especial!</h3>
            
            <div class="mechanic-list" id="mechanic-list">
                <!-- Las mec√°nicas se agregan din√°micamente -->
            </div>
            
            <p class="mechanic-intro-footer">¬°Demuestra tu habilidad!</p>
        </div>
    </div>

    <div id="ranking-modal" class="modal-overlay hidden">
        <div class="modal-backdrop" onclick="closeRankingModal()"></div>
        
        <div class="ranking-modal-box">
            <!-- Header -->
            <div class="ranking-header">
                <div class="header-left">
                    <div class="header-icon trophy">
                        üèÜ
                    </div>
                    <h2>Ranking Global</h2>
                </div>
                <button class="btn-close" onclick="closeRankingModal()">‚úï</button>
            </div>
            
            <!-- Content (3 estados posibles) -->
            <div class="ranking-content">
                
                <!-- ESTADO 1: CARGANDO -->
                <div id="ranking-loading" class="ranking-state">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <!-- ESTADO 2: ERROR -->
                <div id="ranking-error" class="ranking-state hidden">
                    <p class="error-message" id="error-text">Error al cargar el ranking</p>
                    <button class="btn-retry" onclick="loadRanking()">
                        Reintentar
                    </button>
                </div>
                
                <!-- ESTADO 3: √âXITO - LISTA DE JUGADORES -->
                <div id="ranking-success" class="ranking-state hidden">
                    <!-- Icono central -->
                    <div class="ranking-trophy-badge">
                        <div class="trophy-badge">
                            üèÜ
                        </div>
                    </div>
                    
                    <h3 class="ranking-title">Ranking de Google Play Games</h3>
                    <p class="ranking-subtitle">Compite con jugadores de todo el mundo</p>
                    
                    <!-- Tabla de ranking -->
                    <div class="ranking-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>Jugador</th>
                                    <th>Puntos</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-list">
                                <!-- Datos desde Firebase -->
                                <tr class="rank-1">
                                    <td class="position">ü•á</td>
                                    <td class="player">Jugador 1</td>
                                    <td class="score">15,420</td>
                                </tr>
                                <tr class="rank-2">
                                    <td class="position">ü•à</td>
                                    <td class="player">Jugador 2</td>
                                    <td class="score">12,850</td>
                                </tr>
                                <tr class="rank-3">
                                    <td class="position">ü•â</td>
                                    <td class="player">Jugador 3</td>
                                    <td class="score">10,200</td>
                                </tr>
                                <tr>
                                    <td class="position">4</td>
                                    <td class="player">Jugador 4</td>
                                    <td class="score">8,500</td>
                                </tr>
                                <tr>
                                    <td class="position">5</td>
                                    <td class="player">Jugador 5</td>
                                    <td class="score">7,200</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bot√≥n para abrir ranking nativo (opcional) -->
                    <button class="btn-open-native-ranking" onclick="openNativeRanking()">
                        Abrir Ranking Completo
                    </button>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="ranking-footer">
                <p>Ranking de Google Play Games</p>
            </div>
        </div>
    </div>
    
    <!-- Cargar Lottie para animaciones -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="partida_ganada.js"></script>
    
    <!-- Cargar datos de niveles -->
    <!-- Los archivos de niveles se cargar√°n din√°micamente seg√∫n el modo -->
    
    <script>
        // Variables del juego
        let currentLevel = 1;
        let lives = 3;
        let cards = 0;
        let currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
        let levelsData = null;
        let currentLevelData = null;
        let gameTimer = null;
        let timeLeft = 0;
        let gameCards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let totalPairs = 0;
        let gameStarted = false;
        
        // ===== SISTEMA DE VIDAS COMPLETO =====
        const LifeSystem = {
            maxLives: 3,
            currentLives: 3,
            lastLifeLost: 0,
            regenTime: 1800000, // 30 minutos en ms
            regenInterval: null,
            
            // Inicializar
            init() {
                // Cargar desde localStorage
                const saved = localStorage.getItem('memoflip_lives');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.currentLives = data.lives;
                    this.lastLifeLost = data.lastLifeLost;
                }
                
                // Verificar regeneraci√≥n al inicio
                this.checkRegeneration();
                
                // Verificar cada minuto
                this.regenInterval = setInterval(() => {
                    this.checkRegeneration();
                }, 60000);
                
                // Actualizar display
                this.updateDisplay();
            },
            
            // Verificar regeneraci√≥n
            checkRegeneration() {
                if (this.currentLives >= this.maxLives) return;
                
                const now = Date.now();
                const timeSince = now - this.lastLifeLost;
                const livesToRegen = Math.floor(timeSince / this.regenTime);
                
                if (livesToRegen > 0) {
                    const newLives = Math.min(this.currentLives + livesToRegen, this.maxLives);
                    const newLastLifeLost = this.lastLifeLost + (livesToRegen * this.regenTime);
                    
                    this.currentLives = newLives;
                    this.lastLifeLost = newLastLifeLost;
                    
                    console.log(`üíö Regeneradas ${livesToRegen} vidas. Total: ${newLives}`);
                    
                    this.save();
                    this.updateDisplay();
                }
            },
            
            // Perder vida
            loseLife() {
                if (this.currentLives > 0) {
                    this.currentLives--;
                    this.lastLifeLost = Date.now();
                    
                    console.log(`üíî Vida perdida. Quedan: ${this.currentLives}`);
                    
                    this.save();
                    this.updateDisplay();
                    
                    // Si se qued√≥ sin vidas, mostrar modal
                    if (this.currentLives === 0) {
                        showNoLivesModal();
                    }
                }
            },
            
            // Ganar vida (por ver anuncio)
            gainLife() {
                if (this.currentLives < this.maxLives) {
                    this.currentLives++;
                    
                    console.log(`üíö Vida ganada. Total: ${this.currentLives}`);
                    
                    this.save();
                    this.updateDisplay();
                }
            },
            
            // Tiempo hasta la pr√≥xima vida
            getTimeUntilNext() {
                if (this.currentLives >= this.maxLives) return 0;
                
                const now = Date.now();
                const timeSince = now - this.lastLifeLost;
                const timeUntilNext = this.regenTime - (timeSince % this.regenTime);
                
                return Math.max(0, timeUntilNext);
            },
            
            // Formatear tiempo MM:SS
            formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            },
            
            // Actualizar display
            updateDisplay() {
                document.getElementById('lives').textContent = this.currentLives;
                
                // Mostrar timer si no tiene todas las vidas
                const timerElement = document.querySelector('.life-timer');
                if (timerElement && this.currentLives < this.maxLives) {
                    const timeLeft = this.getTimeUntilNext();
                    timerElement.textContent = this.formatTime(timeLeft);
                    timerElement.style.display = 'inline';
                } else if (timerElement) {
                    timerElement.style.display = 'none';
                }
            },
            
            // Guardar en localStorage
            save() {
                localStorage.setItem('memoflip_lives', JSON.stringify({
                    lives: this.currentLives,
                    lastLifeLost: this.lastLifeLost
                }));
            }
        };

        // ===== SISTEMA DE MONEDAS COMPLETO =====
        const CoinSystem = {
            totalCoins: 0,
            
            // Inicializar
            init() {
                const saved = localStorage.getItem('memoflip_coins');
                if (saved) {
                    this.totalCoins = parseInt(saved);
                }
                this.updateDisplay();
            },
            
            // Agregar monedas
            addCoins(amount) {
                this.totalCoins += amount;
                console.log(`ü™ô +${amount} monedas. Total: ${this.totalCoins}`);
                this.save();
                this.updateDisplay();
            },
            
            // Actualizar display
            updateDisplay() {
                document.getElementById('cards').textContent = this.totalCoins;
            },
            
            // Guardar
            save() {
                localStorage.setItem('memoflip_coins', this.totalCoins.toString());
            }
        };

        // ===== SISTEMA DE CRON√ìMETRO COMPLETO =====
        const TimerSystem = {
            timeLimit: 0,          // Tiempo l√≠mite del nivel (cuenta atr√°s)
            timeElapsed: 0,        // Tiempo transcurrido
            actualGameTime: 0,     // Tiempo real jugado (cuenta adelante)
            totalFlips: 0,         // Contador de giros
            timerInterval: null,
            gameTimerInterval: null,
            hasStarted: false,     // Si ya empez√≥ el juego
            isPaused: false,       // Si est√° pausado
            
            // Iniciar nivel con cron√≥metro
            startLevel(timeLimitSec) {
                this.timeLimit = timeLimitSec;
                this.timeElapsed = 0;
                this.actualGameTime = 0;
                this.totalFlips = 0;
                this.hasStarted = false;
                this.isPaused = false;
                
                // Limpiar timers anteriores
                this.stop();
                
                // Mostrar/ocultar barra de tiempo
                const timeBarWrapper = document.getElementById('time-bar-wrapper');
                if (timeBarWrapper) {
                    if (timeLimitSec > 0) {
                        timeBarWrapper.style.display = 'block';
                    } else {
                        timeBarWrapper.style.display = 'none';
                    }
                }
                
                // Actualizar displays a 0
                this.updateDisplay();
                this.updateTimeDisplay();
                this.updateFlipsDisplay();
                
                console.log('üéÆ Nivel iniciado. Esperando primer clic...');
            },
            
            // Cron√≥metro de l√≠mite (cuenta atr√°s)
            startCountdown() {
                this.timerInterval = setInterval(() => {
                    if (!this.isPaused) {
                        this.timeElapsed++;
                        
                        // Verificar si se agot√≥ el tiempo
                        if (this.timeElapsed >= this.timeLimit) {
                            this.onTimeUp();
                            return;
                        }
                        
                        this.updateDisplay();
                    }
                }, 1000);
            },
            
            // Cron√≥metro de tiempo jugado (cuenta adelante)
            startGameTimer() {
                this.gameTimerInterval = setInterval(() => {
                    if (!this.isPaused) {
                        this.actualGameTime++;
                        this.updateTimeDisplay();
                    }
                }, 1000);
            },
            
            // Tiempo agotado
            onTimeUp() {
                clearInterval(this.timerInterval);
                clearInterval(this.gameTimerInterval);
                
                console.log('‚è∞ Tiempo agotado!');
                
                // Perder vida
                LifeSystem.loseLife();
                
                // Mostrar modal de derrota
                showDefeatModal();
            },
            
            // Pausar
            pause() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                if (this.gameTimerInterval) clearInterval(this.gameTimerInterval);
            },
            
            // Reanudar
            resume() {
                if (this.timeLimit > 0) this.startCountdown();
                this.startGameTimer();
            },
            
            // Detener
            // Pausar/Reanudar
            togglePause() {
                this.isPaused = !this.isPaused;
                console.log('‚è∏Ô∏è Juego pausado:', this.isPaused);
                return this.isPaused;
            },
            
            stop() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                if (this.gameTimerInterval) clearInterval(this.gameTimerInterval);
            },
            
            // Contar giros
            incrementFlips() {
                // Iniciar cron√≥metros al primer giro
                this.startOnFirstClick();
                
                this.totalFlips++;
                this.updateFlipsDisplay();
            },
            
            // Iniciar cron√≥metros al primer clic
            startOnFirstClick() {
                if (this.hasStarted) return;
                
                this.hasStarted = true;
                console.log('‚è∞ Cron√≥metros iniciados (primer clic)');
                
                // Iniciar cron√≥metro de l√≠mite (si existe)
                if (this.timeLimit > 0) {
                    this.startCountdown();
                }
                
                // Siempre iniciar cron√≥metro de tiempo real
                this.startGameTimer();
            },
            
            // Actualizar barra de progreso
            updateDisplay() {
                if (this.timeLimit > 0) {
                    const percentage = (this.timeElapsed / this.timeLimit) * 100;
                    const timeBar = document.getElementById('time-bar');
                    if (timeBar) {
                        timeBar.style.width = percentage + '%';
                    }
                }
            },
            
            // Actualizar tiempo jugado
            updateTimeDisplay() {
                const minutes = Math.floor(this.actualGameTime / 60);
                const seconds = this.actualGameTime % 60;
                const timeDisplay = document.getElementById('gameTime');
                if (timeDisplay) {
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            },
            
            // Actualizar contador de giros
            updateFlipsDisplay() {
                const flipCounter = document.getElementById('totalFlips');
                if (flipCounter) {
                    flipCounter.textContent = this.totalFlips;
                }
            },
            
            // Formatear tiempo
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        };

        // Sistema de sonidos
        const soundSystem = {
            sounds: {},
            load(name, url) {
                const audio = new Audio(url);
                this.sounds[name] = audio;
            },
            play(name) {
                if (this.sounds[name]) {
                    this.sounds[name].currentTime = 0;
                    this.sounds[name].play().catch(e => console.log('Sonido no disponible:', name));
                }
            }
        };
        
        // Cargar sonidos
        soundSystem.load('cartavolteada', 'sounds/cartavolteada.mp3');
        soundSystem.load('matchexitoso', 'sounds/matchexitoso.mp3');
        soundSystem.load('acierto', 'sounds/acierto.mp3');
        soundSystem.load('fallo', 'sounds/fallo.mp3');
        soundSystem.load('fondo', 'sounds/fondo.mp3');
        
        // Funci√≥n para crear part√≠culas
        function createParticles(emoji, targetElement = null) {
            const container = document.createElement('div');
            container.style.cssText = 'position: fixed; inset: 0; pointer-events: none; z-index: 150;';
            document.body.appendChild(container);
            
            const rect = targetElement ? targetElement.getBoundingClientRect() : 
                { left: window.innerWidth / 2, top: window.innerHeight / 2 };
            
            for (let i = 0; i < 6; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = (rect.left + (rect.width || 0) / 2) + 'px';
                particle.style.top = (rect.top + (rect.height || 0) / 2) + 'px';
                particle.textContent = emoji;
                
                const angle = (Math.PI * 2 * i) / 6;
                const distance = 50 + Math.random() * 50;
                particle.style.setProperty('--tx', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--ty', `${Math.sin(angle) * distance}px`);
                
                container.appendChild(particle);
            }
            
            setTimeout(() => container.remove(), 1000);
        }
        
        // Funci√≥n para lanzar monedas voladoras
        function launchFlyingCoins(fromX, fromY, amount) {
            const targetX = window.innerWidth - 100;
            const targetY = 100;
            
            for (let i = 0; i < amount; i++) {
                const coin = document.createElement('div');
                coin.className = 'flying-coin';
                coin.innerHTML = 'ü™ô';
                coin.style.left = fromX + 'px';
                coin.style.top = fromY + 'px';
                coin.style.setProperty('--target-x', `${targetX - fromX}px`);
                coin.style.setProperty('--target-y', `${targetY - fromY}px`);
                coin.style.animationDelay = `${i * 0.1}s`;
                
                document.body.appendChild(coin);
                setTimeout(() => coin.remove(), 1000 + (i * 100));
            }
        }
        
        // Cartas reales disponibles (210 cartas)
        const availableCards = [];
        for (let i = 1; i <= 210; i++) {
            availableCards.push(`card_${i.toString().padStart(3, '0')}`);
        }
        
        // Inicializar el juego
        // Cargar niveles seg√∫n modo
        function loadLevelsData() {
            return new Promise((resolve, reject) => {
                const selectedMode = getSelectedMode();
                let fileName = '';
                
                // Mapear modo a archivo
                switch(selectedMode) {
                    case 'beginner':
                    case 'relax':
                        fileName = 'levels_principiante.js';
                        break;
                    case 'normal':
                        fileName = 'levels_normal.js';
                        break;
                    case 'extreme':
                        fileName = 'levels_extremo.js';
                        break;
                    default:
                        fileName = 'levels_normal.js';
                }
                
                console.log(`üìÅ Cargando niveles para modo ${selectedMode} desde ${fileName}`);
                
                // Cargar archivo JavaScript din√°micamente
                const script = document.createElement('script');
                script.src = fileName;
                script.onload = () => {
                    if (window.levels && window.levels.levels) {
                        levelsData = window.levels.levels;
                        console.log(`‚úÖ Cargados ${levelsData.length} niveles desde ${fileName}`);
                        resolve(true);
                    } else {
                        console.error(`‚ùå Datos de niveles no encontrados en ${fileName}`);
                        reject(false);
                    }
                };
                script.onerror = () => {
                    console.error(`‚ùå Error cargando ${fileName}`);
                    reject(false);
                };
                
                document.head.appendChild(script);
            });
        }
        
        // Obtener datos del nivel actual
        function getCurrentLevelData() {
            if (!levelsData || currentLevel > levelsData.length) {
                console.warn('‚ö†Ô∏è Nivel no encontrado, usando datos por defecto');
                return {
                    pairs: 4,
                    timeSec: 0,
                    mechanics: ['basic'],
                    theme: 'ocean'
                };
            }
            
            currentLevelData = levelsData[currentLevel - 1];
            console.log(`üìä Nivel ${currentLevel}:`, currentLevelData);
            return currentLevelData;
        }
        
        async function initGame() {
            console.log('üéÆ Inicializando juego...');
            
            // Cargar modo seleccionado desde localStorage
            const savedMode = localStorage.getItem('memoflip_selected_mode');
            if (savedMode) {
                currentMode = savedMode;
                console.log('üéØ Modo cargado desde localStorage:', currentMode);
            } else {
                console.log('‚ö†Ô∏è No hay modo guardado, usando normal por defecto');
            }
            
            // Intentar cargar modo desde Firestore si hay usuario logueado
            const user = localStorage.getItem('user');
            if (user && window.AndroidInterface && window.AndroidInterface.getUserData) {
                try {
                    const userData = JSON.parse(user);
                    window.AndroidInterface.getUserData(userData.uid);
                    console.log('üîÑ Solicitando datos de usuario desde Firestore...');
                } catch (error) {
                    console.error('‚ùå Error solicitando datos de usuario:', error);
                }
            }
            
            try {
                // Cargar datos del modo actual
                await loadLevelsData();
                console.log('‚úÖ Niveles cargados correctamente');
            } catch (error) {
                console.error('‚ùå Error cargando niveles:', error);
                alert('Error cargando niveles. Usando modo por defecto.');
            }
            
            updateUI();
            generateCards();
            
            // Mostrar modal de mec√°nicas si hay mec√°nicas especiales
            const levelData = getCurrentLevelData();
            if (levelData && levelData.mechanics) {
                showMechanicIntro(levelData.mechanics);
            }
            
            // NO iniciar autom√°ticamente - esperar primer clic
            console.log('üéÆ Juego listo. Esperando primer clic...');
        }
        
        // Generar cartas para el nivel - TR√çOS (3 cartas iguales)
        function generateCards() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            
            // Limpiar timers anteriores
            MechanicEngine.clearAll();
            
            // Obtener datos del nivel actual desde JSON
            const levelData = getCurrentLevelData();
            const pairs = levelData.pairs || 4; // N√∫mero de pares/tr√≠os seg√∫n mec√°nica
            const mechanics = levelData.mechanics || ['basic'];
            const isTrioMode = mechanics.includes('trio');
            totalPairs = pairs; // Mantener compatibilidad con el resto del c√≥digo
            matchedPairs = 0;
            
            console.log(`üéØ Generando ${pairs} ${isTrioMode ? 'tr√≠os' : 'pares'} para nivel ${currentLevel} con mec√°nicas:`, mechanics);
            
            // Crear cartas ALEATORIAS y posicionarlas ALEATORIAMENTE
            gameCards = [];
            const totalSlots = 24;
            
            // 1Ô∏è‚É£ SELECCIONAR CARTAS ALEATORIAS
            const shuffledCards = [...availableCards].sort(() => Math.random() - 0.5);
            const selectedCards = shuffledCards.slice(0, pairs);
            
            // 2Ô∏è‚É£ CREAR CARTAS (2 para pares, 3 para tr√≠os)
            const cardsPerGroup = isTrioMode ? 3 : 2;
            for (let i = 0; i < pairs; i++) {
                const cardName = selectedCards[i];
                // Crear cartas id√©nticas para cada grupo
                for (let j = 0; j < cardsPerGroup; j++) {
                    gameCards.push({ 
                        id: i * cardsPerGroup + j, 
                        cardName: cardName, 
                        matched: false, 
                        isFlipped: false,
                        groupId: i // Identificador del grupo (par o tr√≠o)
                    });
                }
            }
            
            // 3Ô∏è‚É£ ALEATORIZAR POSICIONES EN EL GRID
            const availableSlots = [];
            const totalCards = pairs * cardsPerGroup;
            const startSlot = Math.floor((totalSlots - totalCards) / 2);
            for (let i = 0; i < totalCards; i++) {
                availableSlots.push(startSlot + i);
            }
            availableSlots.sort(() => Math.random() - 0.5);
            
            // 4Ô∏è‚É£ ASIGNAR POSICIONES ALEATORIAS
            gameCards.forEach((card, index) => {
                card.slot = availableSlots[index];
            });
            
            // Mezclar cartas
            gameCards = gameCards.sort(() => Math.random() - 0.5);
            
            // Crear 24 slots como en tu dise√±o original
            // Las cartas se posicionan EN EL MEDIO del grid
            for (let slotIndex = 0; slotIndex < 24; slotIndex++) {
                const card = gameCards.find(c => c.slot === slotIndex);
                
                if (card) {
                    const cardElement = document.createElement('button');
                    cardElement.className = 'card';
                    cardElement.dataset.cardId = card.id;
                    cardElement.onclick = () => flipCard(card.id);
                    
                    const cardInner = document.createElement('div');
                    cardInner.className = 'card-inner';
                    
                    // Cara trasera (reverso) - Logo/Portada
                    const cardBack = document.createElement('div');
                    cardBack.className = 'card-back';
                    const backImg = document.createElement('img');
                    backImg.src = 'logo.png';
                    backImg.alt = 'MemoFlip';
                    cardBack.appendChild(backImg);
                    
                    // Cara frontal (anverso) - Imagen de la carta
                    const cardFront = document.createElement('div');
                    cardFront.className = 'card-front';
                    const frontImg = document.createElement('img');
                    frontImg.src = `cards/${card.cardName}.png`;
                    frontImg.alt = `Carta ${card.cardName}`;
                    cardFront.appendChild(frontImg);
                    
                    cardInner.appendChild(cardBack);
                    cardInner.appendChild(cardFront);
                    cardElement.appendChild(cardInner);
                    
                    // Crear objeto carta para mec√°nicas
                    const cardObj = {
                        id: card.id,
                        cardName: card.cardName,
                        element: cardElement,
                        matched: false,
                        isFrozen: false,
                        mechanic: null,
                        mechanicData: {}
                    };
                    
                    // Asignar el objeto carta al elemento
                    card.element = cardElement;
                    card.matched = false;
                    card.isFrozen = false;
                    card.mechanic = null;
                    card.mechanicData = {};
                    grid.appendChild(cardElement);
                } else {
                    // Slot vac√≠o
                    const emptySlot = document.createElement('div');
                    emptySlot.className = 'empty-slot';
                    // Tama√±o responsive
                    const isMobile = window.innerWidth <= 480;
                    const cardSize = isMobile ? '70px' : '80px';
                    
                    emptySlot.style.cssText = `
                        width: ${cardSize} !important;
                        height: ${cardSize} !important;
                        border: 1px solid rgba(255,255,255,0.1);
                        border-radius: 14px;
                        background: rgba(255,255,255,0.05);
                    `;
                    grid.appendChild(emptySlot);
                }
            }
            
            // 6Ô∏è‚É£ INICIAR MEC√ÅNICAS DEL NIVEL
            MechanicEngine.initLevel(levelData, gameCards);
        }
        
        
        // Verificar si las cartas coinciden
        function checkMatch() {
            const levelData = getCurrentLevelData();
            const isTrioMode = levelData.mechanics && levelData.mechanics.includes('trio');
            const requiredCards = isTrioMode ? 3 : 2;
            
            if (flippedCards.length < requiredCards) return;
            
            if (isTrioMode) {
                // MODO TR√çO: 3 cartas
                const [cardId1, cardId2, cardId3] = flippedCards;
                const card1 = gameCards.find(c => c.id === cardId1);
                const card2 = gameCards.find(c => c.id === cardId2);
                const card3 = gameCards.find(c => c.id === cardId3);
                
                const cardElement1 = document.querySelector(`[data-card-id="${cardId1}"]`);
                const cardElement2 = document.querySelector(`[data-card-id="${cardId2}"]`);
                const cardElement3 = document.querySelector(`[data-card-id="${cardId3}"]`);
                
                // Verificar si las 3 cartas son iguales
                if (card1.cardName === card2.cardName && card2.cardName === card3.cardName) {
                    // ‚úÖ TR√çO EXITOSO
                    card1.matched = true;
                    card2.matched = true;
                    card3.matched = true;
                    matchedPairs++;
                    
                    cardElement1.classList.add('matched');
                    cardElement2.classList.add('matched');
                    cardElement3.classList.add('matched');
                    
                    // Aplicar efectos de mec√°nicas al match
                    MechanicEngine.onMatch(card1);
                    MechanicEngine.onMatch(card2);
                    MechanicEngine.onMatch(card3);
                    
                    // üîä SONIDOS DE MATCH
                    soundSystem.play('matchexitoso');
                    
                    // ‚ú® PART√çCULAS DE MATCH
                    createParticles('‚ú®', cardElement1);
                    
                    // ü™ô MONEDAS VOLADORAS
                    const rect = cardElement1.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    launchFlyingCoins(centerX, centerY, 3);
                    
                    // üí∞ AGREGAR MONEDAS AL SISTEMA
                    CoinSystem.addCoins(15); // 15 monedas por tr√≠o
                    
                    // Ganar cartas
                    const earnedCards = Math.max(10, 20 - currentLevel);
                    cards += earnedCards;
                    
                    if (matchedPairs === totalPairs) {
                        setTimeout(completeLevel, 500);
                    }
                } else {
                    // ‚ùå NO MATCH - Voltear las 3 cartas
                    cardElement1.classList.add('wrong');
                    cardElement2.classList.add('wrong');
                    cardElement3.classList.add('wrong');
                    
                    // Aplicar mec√°nicas de error
                    MechanicEngine.onMismatch([card1, card2, card3]);
                    
                    // Voltear cartas de vuelta
                    setTimeout(() => {
                        cardElement1.classList.remove('flipped', 'wrong');
                        cardElement2.classList.remove('flipped', 'wrong');
                        cardElement3.classList.remove('flipped', 'wrong');
                        card1.isFlipped = false;
                        card2.isFlipped = false;
                        card3.isFlipped = false;
                    }, 500);
                }
            } else {
                // MODO PARES: 2 cartas
                const [cardId1, cardId2] = flippedCards;
                const card1 = gameCards.find(c => c.id === cardId1);
                const card2 = gameCards.find(c => c.id === cardId2);
                
                const cardElement1 = document.querySelector(`[data-card-id="${cardId1}"]`);
                const cardElement2 = document.querySelector(`[data-card-id="${cardId2}"]`);
                
                // Verificar si las 2 cartas son iguales
                if (card1.cardName === card2.cardName) {
                    // ‚úÖ PAR EXITOSO
                    card1.matched = true;
                    card2.matched = true;
                    matchedPairs++;
                    
                    cardElement1.classList.add('matched');
                    cardElement2.classList.add('matched');
                    
                    // Aplicar efectos de mec√°nicas al match
                    MechanicEngine.onMatch(card1);
                    MechanicEngine.onMatch(card2);
                    
                    // üîä SONIDOS DE MATCH
                    soundSystem.play('matchexitoso');
                    
                    // ‚ú® PART√çCULAS DE MATCH
                    createParticles('‚ú®', cardElement1);
                    
                    // ü™ô MONEDAS VOLADORAS
                    const rect = cardElement1.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    launchFlyingCoins(centerX, centerY, 3);
                    
                    // üí∞ AGREGAR MONEDAS AL SISTEMA
                    CoinSystem.addCoins(10); // 10 monedas por par
                    
                    // Ganar cartas
                    const earnedCards = Math.max(10, 20 - currentLevel);
                    cards += earnedCards;
                    
                    if (matchedPairs === totalPairs) {
                        setTimeout(completeLevel, 500);
                    }
                } else {
                    // ‚ùå NO MATCH - Voltear las 2 cartas
                    cardElement1.classList.add('wrong');
                    cardElement2.classList.add('wrong');
                    
                    // Aplicar mec√°nicas de error
                    MechanicEngine.onMismatch([card1, card2]);
                    
                    // Voltear cartas de vuelta
                    setTimeout(() => {
                        cardElement1.classList.remove('flipped', 'wrong');
                        cardElement2.classList.remove('flipped', 'wrong');
                        card1.isFlipped = false;
                        card2.isFlipped = false;
                    }, 500);
                }
            }
            
            flippedCards = [];
            updateUI();
        }
        
        // Completar nivel
        
        // Siguiente nivel
        function nextLevel() {
            currentLevel++;
            
            // üîÑ RESETEAR TIEMPO Y GIROS AL CAMBIAR NIVEL
            TimerSystem.stop();
            TimerSystem.totalFlips = 0;
            TimerSystem.actualGameTime = 0;
            TimerSystem.timeElapsed = 0;
            TimerSystem.hasStarted = false;
            TimerSystem.isPaused = false;
            
            // Actualizar displays a 0
            TimerSystem.updateTimeDisplay();
            TimerSystem.updateFlipsDisplay();
            TimerSystem.updateDisplay();
            
            // Resetear variables del juego
            flipCount = 0;
            flippedCards = [];
            matchedPairs = 0;
            
            generateCards();
            updateUI();
            
            // Guardar progreso autom√°ticamente al cambiar de nivel
            if (window.saveGameProgress) {
                setTimeout(() => {
                    window.saveGameProgress();
                }, 500); // Esperar 0.5 segundos para que se actualice el nivel
            }
            
            console.log('üéÆ Nivel', currentLevel, 'iniciado. Tiempo y giros reseteados.');
        }
        
        // Iniciar nivel autom√°ticamente
        function startLevel() {
            // NO iniciar autom√°ticamente - esperar primer clic
            console.log('üéÆ Nivel listo. Esperando primer clic...');
        }
        
        // Pausar juego
        function pauseGame() {
            gameStarted = !gameStarted;
            console.log('‚è∏Ô∏è Juego pausado:', !gameStarted);
        }
        
        // Volver atr√°s
        function goBack() {
            if (confirm('¬øEst√°s seguro de que quieres salir del juego?')) {
                window.location.href = 'index.html';
            }
        }
        
        // Actualizar UI
        function updateUI() {
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('lives').textContent = lives;
            document.getElementById('cards').textContent = cards;
            
            // Actualizar indicador de modo (ya no existe, se maneja en el pill)
            // const modeNames = {
            //     'beginner': 'Tranquilo',
            //     'normal': 'Normal',
            //     'extreme': 'Extremo'
            // };
            // document.getElementById('modeIndicator').textContent = modeNames[currentMode];
            
            // Actualizar informaci√≥n de mec√°nica
            updateMechanicInfo();
        }
        
        // Actualizar informaci√≥n de mec√°nica del nivel actual
        function updateMechanicInfo() {
            const levelData = getCurrentLevelData();
            const mechanics = levelData.mechanics || ['basic'];
            
            // Obtener la primera mec√°nica (o la principal)
            const primaryMechanic = mechanics[0];
            const mechanicInfo = MECHANIC_INFO[primaryMechanic] || MECHANIC_INFO.basic;
            
            // Actualizar el icono
            const mechanicIcon = document.querySelector('.mechanic-icon');
            if (mechanicIcon) {
                mechanicIcon.textContent = mechanicInfo.icon;
            }
            
            // Actualizar el texto
            const mechanicTitle = document.querySelector('.mechanic-text h3');
            const mechanicDescription = document.querySelector('.mechanic-text p');
            
            if (mechanicTitle) {
                mechanicTitle.textContent = `Mec√°nica ${mechanicInfo.name}`;
            }
            
            if (mechanicDescription) {
                mechanicDescription.textContent = mechanicInfo.description;
            }
            
            console.log(`üéØ Mec√°nica actualizada: ${mechanicInfo.name} (${primaryMechanic})`);
        }
        
        // Cambiar modo de juego
        function changeGameMode() {
            const select = document.getElementById('gameModeSelect');
            currentMode = select.value;
            updateUI();
            console.log('Modo cambiado a:', currentMode);
            
            // Recargar niveles del nuevo modo
            loadLevelsData().then(() => {
                console.log('‚úÖ Niveles recargados para nuevo modo');
            }).catch((error) => {
                console.error('‚ùå Error recargando niveles:', error);
            });
        }
        
        // Cambiar nivel inicial
        function changeInitialLevel() {
            const select = document.getElementById('levelSelect');
            currentLevel = parseInt(select.value);
            updateUI();
            console.log('Nivel inicial cambiado a:', currentLevel);
        }
        
        // Cerrar configuraci√≥n
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        // Sistema de cron√≥metro
        function startTimer() {
            const levelData = getCurrentLevelData();
            const timeLimit = levelData.timeSec || 0;
            
            // Solo iniciar cron√≥metro si hay tiempo l√≠mite
            if (timeLimit > 0) {
                timeLeft = timeLimit;
                updateTimerDisplay();
                
                gameTimer = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    
                    if (timeLeft <= 0) {
                        clearInterval(gameTimer);
                        gameOver();
                    }
                }, 1000);
                
                console.log(`‚è∞ Cron√≥metro iniciado: ${timeLimit}s`);
            } else {
                console.log('‚è∞ Sin cron√≥metro para este nivel');
            }
        }
        
        function stopTimer() {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer').textContent = timeString;
        }
        
        function gameOver() {
            console.log('üíÄ ¬°Tiempo agotado!');
            alert('¬°Tiempo agotado! Int√©ntalo de nuevo.');
            // Aqu√≠ podr√≠as reiniciar el nivel o quitar una vida
        }
        
        // Funciones adicionales
        function showRanking() {
            openRankingModal();
        }
        
        function toggleSound() {
            console.log('üîä Toggle sonido...');
            // Aqu√≠ ir√° la l√≥gica del sonido
        }
        
        function showSettings() {
            console.log('‚öôÔ∏è Mostrando ajustes...');
            alert('Ajustes (pr√≥ximamente)');
        }
        
        function togglePause() {
            const isPaused = TimerSystem.togglePause();
            gameStarted = !isPaused;
            
            // Cambiar icono y t√≠tulo del bot√≥n
            const btn = document.getElementById('pause-play-btn');
            const pauseIcon = btn.querySelector('.pause-icon');
            const playIcon = btn.querySelector('.play-icon');
            
            if (isPaused) {
                // Mostrar play, ocultar pause
                pauseIcon.style.display = 'none';
                playIcon.style.display = 'block';
                btn.title = 'Reanudar';
            } else {
                // Mostrar pause, ocultar play
                pauseIcon.style.display = 'block';
                playIcon.style.display = 'none';
                btn.title = 'Pausa';
            }
            
            console.log('‚è∏Ô∏è Juego pausado:', isPaused);
        }
        
        function showMechanicHelp() {
            const list = document.getElementById('mechanic-help-list');
            if (!list) return;
            
            // Obtener mec√°nicas del nivel actual
            const levelData = getCurrentLevelData();
            const levelMechanics = levelData.mechanics || ['basic'];
            
            console.log('üéÆ Mostrando ayuda para mec√°nicas:', levelMechanics);
            
            list.innerHTML = '';
            
            levelMechanics.forEach(mechanic => {
                const info = MECHANIC_INFO[mechanic];
                if (!info) return;
                
                const item = document.createElement('div');
                item.className = 'mechanic-help-item';
                item.innerHTML = `
                    <div class="mechanic-help-header-item">
                        <span class="mechanic-help-icon">${info.icon}</span>
                        <h3 class="mechanic-help-name">${info.name}</h3>
                    </div>
                    <p class="mechanic-help-desc">${info.description}</p>
                `;
                
                list.appendChild(item);
            });
            
            const modal = document.getElementById('mechanic-help-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeMechanicHelp() {
            const modal = document.getElementById('mechanic-help-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Mostrar modal de anuncio de mec√°nicas
        function showMechanicIntro(levelMechanics) {
            // NO mostrar modal en modo Principiante/Relax (todas las mec√°nicas son basic)
            const currentMode = getSelectedMode();
            if (currentMode === 'beginner' || currentMode === 'relax') {
                console.log('üéØ Modo Principiante/Relax - no mostrando modal de mec√°nicas');
                return;
            }
            
            // Filtrar solo mec√°nicas especiales (sin 'basic')
            const specialMechanics = levelMechanics.filter(m => m !== 'basic');
            
            // Si no hay mec√°nicas especiales, no mostrar nada
            if (specialMechanics.length === 0) {
                console.log('üéØ No hay mec√°nicas especiales, no mostrando modal');
                return;
            }
            
            const overlay = document.getElementById('mechanic-intro');
            const list = document.getElementById('mechanic-list');
            
            if (!overlay || !list) {
                console.error('‚ùå Elementos del modal de mec√°nicas no encontrados');
                return;
            }
            
            // Asegurar que el modal est√© oculto antes de mostrarlo
            overlay.classList.remove('show');
            
            // Limpiar lista
            list.innerHTML = '';
            
            // Agregar cada mec√°nica
            specialMechanics.forEach(mechanic => {
                const info = MECHANIC_INFO[mechanic];
                if (!info) return;
                
                const item = document.createElement('div');
                item.className = 'mechanic-item';
                
                const icon = document.createElement('span');
                icon.className = 'mechanic-icon';
                icon.textContent = info.icon;
                
                const name = document.createElement('span');
                name.className = 'mechanic-name';
                name.textContent = info.name;
                
                item.appendChild(icon);
                item.appendChild(name);
                list.appendChild(item);
            });
            
            // Mostrar modal con un peque√±o delay para asegurar que se renderice
            setTimeout(() => {
                overlay.classList.add('show');
                console.log('üéØ Mostrando modal de mec√°nicas:', specialMechanics);
                
                // Ocultar despu√©s de 3 segundos
                setTimeout(() => {
                    overlay.classList.remove('show');
                    console.log('üéØ Modal de mec√°nicas ocultado');
                }, 3000);
            }, 100);
        }

        // ========================================
        // FUNCIONES DE MODALES - COMPLETAS
        // ========================================

        // ===== ESTADO GLOBAL =====
        let soundEnabled = true;
        let vibrationEnabled = true;
        let currentGameMode = 'normal'; // 'beginner', 'normal', 'extreme'
        let flipCount = 0;
        let startTime = 0;

        // ===== MODAL VICTORIA =====
        function showVictoryModal() {
            // Usar el tiempo real del TimerSystem en lugar de Date.now
            const timePlayed = TimerSystem.actualGameTime || 0;
            const earnedCards = Math.max(10, 20 - currentLevel);
            
            document.getElementById('time-played').textContent = formatTime(timePlayed);
            document.getElementById('flips-count').textContent = flipCount;
            document.getElementById('coins-earned').textContent = `+ ${earnedCards} monedas`;
            
            // Cargar animaci√≥n Lottie SOLO UNA VEZ
            if (window.lottie && window.PARTIDA_GANADA_ANIMATION && !window.victoryAnimationLoaded) {
                console.log('üé¨ Cargando animaci√≥n Lottie desde datos...');
                lottie.loadAnimation({
                    container: document.getElementById('lottie-victory'),
                    renderer: 'svg',
                    loop: false,
                    autoplay: true,
                    animationData: window.PARTIDA_GANADA_ANIMATION
                });
                window.victoryAnimationLoaded = true;
                console.log('‚úÖ Animaci√≥n Lottie cargada desde datos');
            } else if (window.lottie && window.victoryAnimationLoaded) {
                console.log('üé¨ Animaci√≥n Lottie ya cargada, reutilizando...');
            } else {
                console.log('‚ùå Lottie o datos no disponibles');
            }
            
            document.getElementById('modal-victory').classList.remove('hidden');
            soundSystem.play('acierto');
        }

        // ===== MODAL DERROTA =====
        function showDefeatModal() {
            const levelData = getCurrentLevelData();
            const timeLimit = levelData.timeSec || 0;
            const earnedCards = Math.max(5, 10 - currentLevel);
            
            document.getElementById('failed-level').textContent = currentLevel;
            document.getElementById('time-limit').textContent = formatTime(timeLimit);
            document.getElementById('coins-earned-fail').textContent = earnedCards;
            document.getElementById('lives-remaining').textContent = lives;
            
            document.getElementById('modal-defeat').classList.remove('hidden');
            soundSystem.play('fallo');
        }

        // ===== MODAL SIN VIDAS =====
        function showNoLivesModal() {
            document.getElementById('modal-no-lives').classList.remove('hidden');
            startLifeRegenTimer();
        }

        // ===== MODAL CONFIGURACI√ìN =====
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        // ===== TOGGLE SONIDO =====
        function toggleSound() {
            soundEnabled = !soundEnabled;
            
            // Guardar configuraci√≥n en localStorage
            const settings = getSettings();
            settings.soundEnabled = soundEnabled;
            saveSettings(settings);
            
            const icon = document.getElementById('sound-icon');
            const name = document.getElementById('sound-name');
            const desc = document.getElementById('sound-desc');
            const toggle = document.getElementById('sound-toggle');
            
            if (soundEnabled) {
                icon.textContent = 'üîä';
                name.textContent = 'Sonido Activado';
                desc.textContent = 'M√∫sica y efectos activos';
                toggle.textContent = 'Desactivar';
                toggle.classList.add('active');
                
                soundSystem.play('cartavolteada');
            } else {
                icon.textContent = 'üîá';
                name.textContent = 'Sonido Desactivado';
                desc.textContent = 'Modo silencioso';
                toggle.textContent = 'Activar';
                toggle.classList.remove('active');
            }
            
            console.log('üîä Sonido:', soundEnabled ? 'Activado' : 'Desactivado');
        }

        // ===== TOGGLE VIBRACI√ìN =====
        function toggleVibration() {
            vibrationEnabled = !vibrationEnabled;
            
            // Guardar configuraci√≥n en localStorage
            const settings = getSettings();
            settings.vibrationEnabled = vibrationEnabled;
            saveSettings(settings);
            
            const icon = document.getElementById('vibration-icon');
            const name = document.getElementById('vibration-name');
            const desc = document.getElementById('vibration-desc');
            const toggle = document.getElementById('vibration-toggle');
            
            if (vibrationEnabled) {
                icon.textContent = 'üì±';
                name.textContent = 'Vibraci√≥n Activada';
                desc.textContent = 'Vibraci√≥n al tocar cartas';
                toggle.textContent = 'Desactivar';
                toggle.classList.add('active');
            } else {
                icon.textContent = 'üìµ';
                name.textContent = 'Vibraci√≥n Desactivada';
                desc.textContent = 'Sin vibraci√≥n';
                toggle.textContent = 'Activar';
                toggle.classList.remove('active');
            }
            
            if (soundEnabled) {
                soundSystem.play('cartavolteada');
            }
            
            console.log('üì≥ Vibraci√≥n:', vibrationEnabled ? 'Activada' : 'Desactivada');
        }

        // ===== CAMBIAR MODO DE JUEGO =====
        function changeGameMode(mode) {
            // Remover active de todos
            document.getElementById('mode-beginner').classList.remove('active');
            document.getElementById('mode-normal').classList.remove('active');
            document.getElementById('mode-extreme').classList.remove('active');
            
            // Remover active de indicators
            document.querySelectorAll('.mode-indicator').forEach(ind => {
                ind.classList.remove('active');
            });
            
            // Agregar active al seleccionado
            const button = document.getElementById(`mode-${mode}`);
            button.classList.add('active');
            button.querySelector('.mode-indicator').classList.add('active');
            
            currentGameMode = mode;
            
            if (soundEnabled) {
                soundSystem.play('cartavolteada');
            }
            
            console.log('üéÆ Modo cambiado a:', mode);
        }

        // ===== LOGIN CON GOOGLE =====
        function loginWithGoogle() {
            console.log('üîµ Iniciando login con Google...');
            if (window.tryFirebaseLogin) {
                window.tryFirebaseLogin().then(user => {
                    console.log('‚úÖ Login exitoso:', user);
                    closeSettingsModal();
                }).catch(error => {
                    console.error('‚ùå Error en login:', error);
                    alert('Error al iniciar sesi√≥n');
                });
            } else {
                alert('Funci√≥n de login con Google no disponible');
            }
        }

        // ===== CERRAR SESI√ìN =====
        function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                console.log('üö™ Cerrando sesi√≥n...');
                
                localStorage.removeItem('memoflip_user_email');
                localStorage.removeItem('memoflip_user_token');
                localStorage.removeItem('memoflip_progress');
                
                document.getElementById('account-logged-in').classList.add('hidden');
                document.getElementById('account-logged-out').classList.remove('hidden');
                
                closeSettingsModal();
                
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            }
        }

        // ===== ELIMINAR CUENTA =====
        function deleteAccount() {
            if (confirm('¬øEst√°s seguro de que quieres solicitar la eliminaci√≥n de tu cuenta?')) {
                const email = document.getElementById('user-email').textContent;
                const subject = encodeURIComponent('MemoFlip - Solicitud de baja de cuenta');
                const body = encodeURIComponent(
                    `Solicito la baja de mi cuenta en la aplicaci√≥n MemoFlip.\n\n` +
                    `Email de la cuenta: ${email}\n\n` +
                    `Por favor, eliminen todos mis datos personales y progreso del juego.\n\n` +
                    `Gracias.`
                );
                
                window.location.href = `mailto:info@intocables13.com?subject=${subject}&body=${body}`;
                alert('Se ha abierto tu cliente de correo. Por favor, env√≠a el mensaje para completar la solicitud.');
                closeSettingsModal();
            }
        }

        // ===== MODAL ANUNCIO DE MEC√ÅNICAS =====
        const MECHANIC_ICONS = {
            fog: 'üå´Ô∏è',
            ghost: 'üëª',
            bomb: 'üí£',
            chameleon: 'ü¶é',
            darkness: 'üåë',
            rotation: 'üîÑ',
            frozen: '‚ùÑÔ∏è',
            peeked_card: 'üëÅÔ∏è',
            trio: '3Ô∏è‚É£'
        };

        const MECHANIC_NAMES = {
            fog: 'Niebla',
            ghost: 'Fantasma',
            bomb: 'Bomba',
            chameleon: 'Camale√≥n',
            darkness: 'Oscuridad',
            rotation: 'Rotaci√≥n',
            frozen: 'Congelado',
            peeked_card: 'Vista Previa',
            trio: 'Tr√≠o'
        };

        function showMechanicIntro(levelMechanics) {
            const specialMechanics = levelMechanics.filter(m => m !== 'basic');
            
            if (specialMechanics.length === 0) return;
            
            const overlay = document.getElementById('mechanic-intro');
            const list = document.getElementById('mechanic-list');
            
            list.innerHTML = '';
            
            specialMechanics.forEach((mechanic) => {
                const item = document.createElement('div');
                item.className = 'mechanic-item';
                
                const icon = document.createElement('span');
                icon.className = 'mechanic-icon';
                icon.textContent = MECHANIC_ICONS[mechanic] || '‚ùì';
                
                const name = document.createElement('span');
                name.className = 'mechanic-name';
                name.textContent = MECHANIC_NAMES[mechanic] || mechanic;
                
                item.appendChild(icon);
                item.appendChild(name);
                list.appendChild(item);
            });
            
            overlay.classList.remove('hidden');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 3000);
        }

        // ===== FUNCIONES AUXILIARES =====
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function startLifeRegenTimer() {
            // Simular timer de regeneraci√≥n de vidas
            let timeLeft = 30 * 60; // 30 minutos en segundos
            
            const timer = setInterval(() => {
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('life-timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(timer);
                    document.getElementById('life-timer').textContent = '00:00';
                }
            }, 1000);
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar si hay usuario logueado
            const userEmail = localStorage.getItem('memoflip_user_email');
            
            if (userEmail) {
                document.getElementById('account-logged-out').classList.add('hidden');
                document.getElementById('account-logged-in').classList.remove('hidden');
                document.getElementById('user-email').textContent = userEmail;
            }

            // Event listeners para botones de modales
            document.getElementById('btn-next-level')?.addEventListener('click', () => {
                document.getElementById('modal-victory').classList.add('hidden');
                nextLevel();
            });

            document.getElementById('btn-exit')?.addEventListener('click', () => {
                document.getElementById('modal-defeat').classList.add('hidden');
                goBack();
            });

            document.getElementById('btn-retry')?.addEventListener('click', () => {
                document.getElementById('modal-defeat').classList.add('hidden');
                initGame();
            });

            document.getElementById('btn-close-no-lives')?.addEventListener('click', () => {
                document.getElementById('modal-no-lives').classList.add('hidden');
            });

            document.getElementById('btn-watch-ad')?.addEventListener('click', () => {
                document.getElementById('modal-no-lives').classList.add('hidden');
                // Simular ver anuncio y recuperar vida
                lives = 1;
                updateUI();
                alert('¬°Vida recuperada!');
            });
        });

        // ===== NAVEGACI√ìN =====
        function goToMainMenu() {
            console.log('üè† Volviendo al men√∫ principal...');
            // Cargar la pantalla de inicio
            window.location.href = 'index.html';
        }
        
        // ===== LOGIN DESDE JUEGO =====
        function loginWithGoogleFromGame() {
            console.log('üîê Iniciando login con Google desde juego...');
            if (window.AndroidInterface && window.AndroidInterface.login) {
                window.AndroidInterface.login();
            } else {
                console.error('‚ùå AndroidInterface.login no disponible');
                alert('Error: AndroidInterface no disponible');
            }
        }

        // ===== ACTUALIZAR FUNCIONES EXISTENTES =====
        function flipCard(cardId) {
            const card = gameCards.find(c => c.id === cardId);
            if (!card || card.matched || card.isFlipped || flippedCards.includes(cardId)) return;
            
            // üö´ VERIFICAR MEC√ÅNICAS QUE BLOQUEAN CLICKS
            if (!MechanicEngine.canClickCard(card)) {
                console.log('‚ùå Carta bloqueada por mec√°nica');
                return;
            }
            
            // üö´ LIMITAR CARTAS ABIERTAS SEG√öN MODO
            const levelData = getCurrentLevelData();
            const isTrioMode = levelData.mechanics && levelData.mechanics.includes('trio');
            const maxCards = isTrioMode ? 3 : 2;
            
            if (flippedCards.length >= maxCards) {
                console.log(`‚ùå Ya hay ${maxCards} cartas abiertas, esperando...`);
                return;
            }
            
            // üéÆ INICIAR CRON√ìMETROS AL PRIMER CLIC
            TimerSystem.incrementFlips();
            
            flippedCards.push(cardId);
            card.isFlipped = true;
            flipCount++; // Contar giros
            
            const cardElement = document.querySelector(`[data-card-id="${cardId}"]`);
            cardElement.classList.add('flipped');
            
            if (soundEnabled) {
                soundSystem.play('cartavolteada');
            }
            
            if (flippedCards.length === maxCards) {
                setTimeout(checkMatch, 500);
            }
        }

        function completeLevel() {
            console.log('üéâ Nivel completado!');
            
            // Detener cron√≥metros
            TimerSystem.stop();
            
            // üîÑ RESETEAR VARIABLES DEL JUEGO
            flippedCards = [];
            matchedPairs = 0;
            
            // Calcular monedas de bonificaci√≥n
            const timeBonus = TimerSystem.timeLimit > 0 
                ? Math.max(0, (TimerSystem.timeLimit - TimerSystem.timeElapsed) * 2) 
                : 0;
            
            // Calcular monedas basadas en tiempo y giros
            let totalCoins = 10; // Base
            
            // Bonificaci√≥n por tiempo (m√°s r√°pido = m√°s monedas)
            if (TimerSystem.actualGameTime > 0) {
                const timeBonus = Math.max(0, 30 - TimerSystem.actualGameTime);
                totalCoins += Math.floor(timeBonus / 5);
            }
            
            // Bonificaci√≥n por eficiencia (menos giros = m√°s monedas)
            const minFlips = currentLevel * 2; // M√≠nimo te√≥rico
            if (TimerSystem.totalFlips > minFlips) {
                const efficiencyBonus = Math.max(0, minFlips - TimerSystem.totalFlips);
                totalCoins += Math.floor(efficiencyBonus / 2);
            }
            
            totalCoins = Math.max(1, totalCoins);
            CoinSystem.addCoins(totalCoins);
            
            // Actualizar estad√≠sticas del modo
            const modeProgress = getModeProgress(currentMode);
            const coinElement = document.getElementById('coin-counter');
            const currentCoins = coinElement ? parseInt(coinElement.textContent) || 0 : modeProgress.coins;
            
            const updatedProgress = {
                ...modeProgress,
                level: Math.max(modeProgress.level, currentLevel + 1),
                coins: currentCoins,
                totalGames: modeProgress.totalGames + 1,
                totalWins: modeProgress.totalWins + 1,
                lastPlayed: new Date().toISOString()
            };
            saveModeProgress(currentMode, updatedProgress);
            
            // Guardar progreso autom√°ticamente
            if (window.saveGameProgress) {
                setTimeout(() => {
                    window.saveGameProgress();
                }, 1000); // Esperar 1 segundo para que se actualicen las monedas
            }
            
            showVictoryModal();
        }

        function gameOver() {
            console.log('üíÄ Game Over!');
            
            // Detener cron√≥metros
            TimerSystem.stop();
            
            // Perder vida usando el sistema
            LifeSystem.loseLife();
            
            // Mostrar modal seg√∫n vidas restantes
            if (LifeSystem.currentLives <= 0) {
                showNoLivesModal();
            } else {
                showDefeatModal();
            }
        }

        function startTimer() {
            const levelData = getCurrentLevelData();
            const timeLimit = levelData.timeSec || 0;
            
            // Usar el sistema de cron√≥metro completo
            TimerSystem.startLevel(timeLimit);
        }

        // ===== ACTUALIZAR FUNCI√ìN showSettings =====
        function showSettings() {
            openSettingsModal();
        }

        // ===== SISTEMA DE RANKING =====
        let currentRankingData = [];

        // ===== TEXTOS DE MEC√ÅNICAS =====
        const MECHANIC_INFO = {
            basic: {
                icon: 'üéØ',
                name: 'B√°sica',
                description: 'Mec√°nica est√°ndar sin efectos especiales. Simplemente encuentra las parejas iguales.'
            },
            ghost: {
                icon: 'üëª',
                name: 'Fantasma',
                description: 'Las cartas aparecen y desaparecen. Cuando est√°n ocultas, se muestra un fantasma en su lugar.'
            },
            fog: {
                icon: 'üí®',
                name: 'Niebla',
                description: 'Las cartas se ven borrosas y semi-transparentes, dificultando su identificaci√≥n.'
            },
            chameleon: {
                icon: 'ü¶é',
                name: 'Camale√≥n',
                description: 'Todo el grid cambia de color peri√≥dicamente (verde, rojo, azul, amarillo) para confundir.'
            },
            bomb: {
                icon: 'üí£',
                name: 'Bomba',
                description: '20% de cartas tienen bombas. Al tocar una, todas pasan de amarillo ‚Üí naranja ‚Üí rojo ‚Üí explotan.'
            },
            trio: {
                icon: 'üî∫',
                name: 'Tr√≠o',
                description: 'En lugar de parejas, necesitas hacer grupos de 3 cartas id√©nticas.'
            },
            rotation: {
                icon: 'üîÑ',
                name: 'Rotaci√≥n',
                description: 'El tablero rota peri√≥dicamente, cambiando la orientaci√≥n de las cartas.'
            },
            peeked_card: {
                icon: 'üëÅÔ∏è',
                name: 'Vista Previa',
                description: 'Una carta se muestra brevemente al inicio para darte una pista.'
            },
            combo: {
                icon: '‚ö°',
                name: 'Combo',
                description: 'Bonificaciones por hacer secuencias de aciertos consecutivos.'
            },
            frozen: {
                icon: 'üßä',
                name: 'Congelaci√≥n',
                description: 'Algunas cartas se congelan temporalmente y no se pueden voltear. Las cartas emparejadas nunca se congelan.'
            },
            darkness: {
                icon: 'üåë',
                name: 'Oscuridad',
                description: 'Toda la pantalla se oscurece peri√≥dicamente, dificultando la visi√≥n.'
            }
        };

        // ===== MEC√ÅNICAS INDIVIDUALES =====
        
        // üëª GHOST: 25% cartas, aparecer/desaparecer 1-3s
        const GhostMechanic = {
            applyToLevel(cards) {
                cards.forEach(card => {
                    if (Math.random() < 0.25) { // 25% probabilidad
                        this.applyToCard(card);
                    }
                });
            },
            
            applyToCard(card) {
                card.mechanic = 'ghost';
                card.mechanicData = {
                    isVisible: true,
                    visibilityDuration: Math.random() * 2 + 1 // 1-3s aleatorio por carta
                };
                
                card.element.classList.add('ghost');
                
                console.log('üëª Aplicando mec√°nica ghost a carta:', card.id);
                
                // Crear emoji fantasma
                const ghostEmoji = document.createElement('div');
                ghostEmoji.className = 'ghost-emoji';
                ghostEmoji.textContent = 'üëª';
                ghostEmoji.style.display = 'none'; // Inicialmente oculto
                ghostEmoji.style.position = 'absolute';
                ghostEmoji.style.top = '0';
                ghostEmoji.style.left = '0';
                ghostEmoji.style.right = '0';
                ghostEmoji.style.bottom = '0';
                ghostEmoji.style.zIndex = '100';
                card.element.appendChild(ghostEmoji);
                card.ghostEmoji = ghostEmoji;
                
                console.log('üëª Emoji fantasma creado para carta:', card.id, 'Elemento:', ghostEmoji);
                
                // Timer independiente para esta carta
                this.startTimer(card);
            },
            
            startTimer(card) {
                const toggle = () => {
                    // Si est√° emparejada, DETENER y dejar visible
                    if (card.matched) {
                        card.element.classList.remove('invisible', 'ghost');
                        card.element.style.opacity = '1';
                        if (card.ghostEmoji) {
                            card.ghostEmoji.style.display = 'none';
                        }
                        return; // ‚Üê Detener timer
                    }
                    
                    // Alternar
                    card.mechanicData.isVisible = !card.mechanicData.isVisible;
                    
                    if (card.mechanicData.isVisible) {
                        // Carta visible - ocultar emoji fantasma
                        card.element.classList.remove('invisible');
                        if (card.ghostEmoji) {
                            card.ghostEmoji.style.display = 'none';
                            card.ghostEmoji.style.opacity = '0';
                        }
                        console.log('üëª Carta visible:', card.id);
                    } else {
                        // Carta invisible - mostrar emoji fantasma
                        card.element.classList.add('invisible');
                        if (card.ghostEmoji) {
                            card.ghostEmoji.style.display = 'flex';
                            card.ghostEmoji.style.opacity = '1';
                        }
                        console.log('üëª Carta invisible, mostrando emoji:', card.id, 'Elemento:', card.ghostEmoji);
                    }
                    
                    // Siguiente toggle (aleatorio 1-3s)
                    setTimeout(toggle, (Math.random() * 2 + 1) * 1000);
                };
                
                // Primera alternancia
                setTimeout(toggle, card.mechanicData.visibilityDuration * 1000);
            },
            
            canClick(card) {
                if (card.mechanic !== 'ghost') return true;
                if (card.matched) return true;
                return card.mechanicData.isVisible;
            }
        };
        
        // üí® FOG: 30% cartas, blur y transparencia
        const FogMechanic = {
            applyToLevel(cards) {
                cards.forEach(card => {
                    if (Math.random() < 0.3) { // 30% probabilidad
                        this.applyToCard(card);
                    }
                });
            },
            
            applyToCard(card) {
                card.mechanic = 'fog';
                const fogLevel = Math.random() * 0.8 + 0.2; // 0.2 a 1.0
                
                card.mechanicData = { fogLevel };
                
                // Aplicar efectos CSS
                card.element.style.filter = `blur(${fogLevel * 8}px)`;
                card.element.style.opacity = Math.max(0.3, fogLevel);
                card.element.classList.add('fog');
            },
            
            // Al emparejar: quitar niebla
            onMatch(card) {
                if (card.mechanic === 'fog') {
                    card.element.style.filter = 'none';
                    card.element.style.opacity = '1';
                }
            }
        };
        
        // üí£ BOMB: 20% cartas, niveles amarillo‚Üínaranja‚Üírojo‚Üíexplosi√≥n
        const BombMechanic = {
            applyToLevel(cards) {
                const totalCards = cards.length;
                const bombCount = Math.floor(totalCards * 0.2); // 20%
                
                // Seleccionar cartas aleatorias para bombas
                const shuffled = [...cards].sort(() => Math.random() - 0.5);
                const bombCards = shuffled.slice(0, bombCount);
                
                bombCards.forEach(card => {
                    this.applyToCard(card);
                });
            },
            
            applyToCard(card) {
                card.mechanic = 'bomb';
                card.mechanicData = {
                    bombLevel: 0,
                    isExploded: false
                };
                
                card.element.classList.add('bomb', 'bomb-level-0');
            },
            
            // Cuando hay un error (no match)
            onMismatch(allCards) {
                allCards.forEach(card => {
                    if (card.mechanic === 'bomb' && !card.matched) {
                        card.mechanicData.bombLevel++;
                        
                        // Actualizar visual
                        card.element.classList.remove('bomb-level-0', 'bomb-level-1', 'bomb-level-2');
                        card.element.classList.add(`bomb-level-${card.mechanicData.bombLevel}`);
                        
                        // Si llega a nivel 3: EXPLOSI√ìN
                        if (card.mechanicData.bombLevel >= 3) {
                            card.mechanicData.isExploded = true;
                            card.element.classList.add('exploded');
                            
                            // Crear part√≠culas de explosi√≥n
                            createParticles('üí•', card.element);
                            
                            // Desaparecer despu√©s de animaci√≥n
                            setTimeout(() => {
                                card.element.style.display = 'none';
                            }, 300);
                            
                            console.log('üí• Bomba explotada!');
                        }
                    }
                });
            }
        };
        
        // ‚ùÑÔ∏è FROZEN: Congelar 2 cartas cada 6s por 3s
        const FrozenMechanic = {
            intervalMs: 6000,  // Congelar cada 6 segundos
            durationMs: 3000,  // Durar 3 segundos
            
            start(cards) {
                const freezeCycle = () => {
                    // Seleccionar 2 cartas NO emparejadas
                    const available = cards.filter(c => !c.matched && !c.isFrozen);
                    
                    if (available.length >= 2) {
                        // Barajar y tomar 2
                        const shuffled = available.sort(() => Math.random() - 0.5);
                        const toFreeze = shuffled.slice(0, 2);
                        
                        toFreeze.forEach(card => {
                            card.isFrozen = true;
                            card.element.classList.add('frozen');
                            
                            // Agregar emoji de hielo
                            const iceEmoji = document.createElement('div');
                            iceEmoji.className = 'ice-emoji';
                            iceEmoji.textContent = '‚ùÑÔ∏è';
                            card.element.appendChild(iceEmoji);
                            card.iceEmoji = iceEmoji;
                        });
                        
                        console.log('üßä 2 cartas congeladas por 3s');
                        
                        // Descongelar despu√©s de 3s
                        setTimeout(() => {
                            toFreeze.forEach(card => {
                                card.isFrozen = false;
                                card.element.classList.remove('frozen');
                                if (card.iceEmoji) {
                                    card.iceEmoji.remove();
                                }
                            });
                            console.log('üî• Cartas descongeladas');
                        }, this.durationMs);
                    }
                    
                    // Repetir ciclo cada 6s
                    setTimeout(freezeCycle, this.intervalMs);
                };
                
                // Iniciar primer ciclo
                setTimeout(freezeCycle, this.intervalMs);
            },
            
            canClick(card) {
                return !card.isFrozen;
            }
        };
        
        // üîÑ ROTATION: Rotar todas las cartas cada 2s
        const RotationMechanic = {
            start(cards) {
                setInterval(() => {
                    cards.forEach(card => {
                        if (!card.matched) {
                            // √Ångulo aleatorio
                            const angles = [0, 90, 180, 270];
                            const angle = angles[Math.floor(Math.random() * 4)];
                            
                            card.element.style.transform = `rotate(${angle}deg)`;
                            card.mechanicData = { rotation: angle };
                        }
                    });
                    
                    console.log('üîÑ Cartas rotadas');
                }, 2000);
            }
        };
        
        // ü¶é CHAMELEON: Cambiar color del grid cada 2s
        const ChameleonMechanic = {
            colors: ['normal', 'green', 'red', 'blue', 'yellow'],
            currentIndex: 0,
            
            start() {
                setInterval(() => {
                    const grid = document.getElementById('cardsGrid');
                    
                    // Remover color anterior
                    grid.classList.remove('filter-green', 'filter-red', 'filter-blue', 'filter-yellow');
                    
                    // Siguiente color
                    this.currentIndex = (this.currentIndex + 1) % this.colors.length;
                    const color = this.colors[this.currentIndex];
                    
                    if (color !== 'normal') {
                        grid.classList.add(`filter-${color}`);
                    }
                    
                    console.log('ü¶é Color cambiado a:', color);
                }, 2000);
            }
        };
        
        // üëÅÔ∏è PEEKED_CARD: 40% cartas, auto-peek cada 10s por 2s
        const PeekedMechanic = {
            applyToLevel(cards) {
                cards.forEach(card => {
                    if (Math.random() < 0.4) { // 40% probabilidad
                        this.applyToCard(card);
                    }
                });
            },
            
            applyToCard(card) {
                card.mechanic = 'peeked_card';
                
                const peekCycle = () => {
                    if (card.matched) return; // Detener si est√° emparejada
                    
                    // Voltear
                    card.element.classList.add('flipped', 'auto-peeked');
                    console.log('üëÅÔ∏è Carta auto-peek');
                    
                    // Cerrar despu√©s de 2s
                    setTimeout(() => {
                        if (!card.matched) {
                            card.element.classList.remove('flipped', 'auto-peeked');
                        }
                        
                        // Repetir en 10s
                        setTimeout(peekCycle, 10000);
                    }, 2000);
                };
                
                // Primer peek despu√©s de 1s
                setTimeout(peekCycle, 1000);
            }
        };
        
        // üåë DARKNESS: Oscuridad gradual en todas las cartas
        const DarknessMechanic = {
            darknessLevel: 0,
            
            start(cards) {
                const darknessLoop = () => {
                    // Aumentar oscuridad gradualmente
                    this.darknessLevel = Math.min(0.8, this.darknessLevel + 0.002);
                    
                    cards.forEach(card => {
                        if (!card.matched) {
                            card.element.style.filter = `brightness(${1 - this.darknessLevel})`;
                            card.element.style.opacity = 1 - (this.darknessLevel * 0.5);
                        }
                    });
                    
                    requestAnimationFrame(darknessLoop);
                };
                
                requestAnimationFrame(darknessLoop);
            }
        };
        
        // ===== MOTOR DE MEC√ÅNICAS =====
        const MechanicEngine = {
            activeCards: [],
            timers: [],
            intervals: [],
            
            // Limpiar todos los timers e intervalos
            clearAll() {
                this.timers.forEach(timer => clearTimeout(timer));
                this.intervals.forEach(interval => clearInterval(interval));
                this.timers = [];
                this.intervals = [];
                this.activeCards = [];
            },
            
            // Inicializar nivel con mec√°nicas
            initLevel(levelData, cards) {
                this.activeCards = cards;
                console.log('üéÆ Iniciando mec√°nicas:', levelData.mechanics);
                
                levelData.mechanics.forEach(mechanic => {
                    switch(mechanic) {
                        case 'ghost':
                            GhostMechanic.applyToLevel(cards);
                            break;
                        case 'fog':
                            FogMechanic.applyToLevel(cards);
                            break;
                        case 'bomb':
                            BombMechanic.applyToLevel(cards);
                            break;
                        case 'frozen':
                            FrozenMechanic.start(cards);
                            break;
                        case 'rotation':
                            RotationMechanic.start(cards);
                            break;
                        case 'chameleon':
                            ChameleonMechanic.start();
                            break;
                        case 'peeked_card':
                            PeekedMechanic.applyToLevel(cards);
                            break;
                        case 'darkness':
                            DarknessMechanic.start(cards);
                            break;
                    }
                });
            },
            
            // Verificar si se puede hacer click en una carta
            canClickCard(card) {
                if (card.isFrozen) return false;
                if (card.mechanic === 'ghost' && !GhostMechanic.canClick(card)) return false;
                return true;
            },
            
            // Cuando hay error (no match)
            onMismatch(cards) {
                BombMechanic.onMismatch(this.activeCards);
            },
            
            // Cuando hay match exitoso
            onMatch(card) {
                FogMechanic.onMatch(card);
            }
        };

        // ========================================
        // ABRIR MODAL
        // ========================================
        function openRankingModal() {
            document.getElementById('ranking-modal').classList.remove('hidden');
            loadRanking();
        }

        function closeRankingModal() {
            document.getElementById('ranking-modal').classList.add('hidden');
        }

        // ========================================
        // CARGAR RANKING DESDE FIREBASE
        // ========================================
        async function loadRanking() {
            // Mostrar estado de carga
            showRankingState('loading');
            
            try {
                // ========================================
                // üî• AQU√ç CONECTAS CON FIREBASE
                // ========================================
                
                // Ejemplo con Firebase (reemplazar con tu c√≥digo):
                /*
                const db = firebase.firestore();
                const snapshot = await db.collection('rankings')
                  .orderBy('score', 'desc')
                  .limit(50)
                  .get();
                
                const rankingData = [];
                snapshot.forEach(doc => {
                  rankingData.push({
                    name: doc.data().name,
                    score: doc.data().score,
                    level: doc.data().level
                  });
                });
                */
                
                // ========================================
                // SIMULACI√ìN (reemplazar con datos reales)
                // ========================================
                const rankingData = [
                    { name: 'Jugador Pro', score: 15420, level: 50 },
                    { name: 'Master Memory', score: 12850, level: 45 },
                    { name: 'Card Wizard', score: 10200, level: 40 },
                    { name: 'Brain Power', score: 8500, level: 38 },
                    { name: 'Fast Fingers', score: 7200, level: 35 },
                    { name: 'Memory King', score: 6800, level: 32 },
                    { name: 'Quick Mind', score: 5900, level: 30 },
                    { name: 'Card Master', score: 5200, level: 28 },
                    { name: 'Flip Expert', score: 4700, level: 25 },
                    { name: 'Pro Gamer', score: 4100, level: 22 }
                ];
                
                currentRankingData = rankingData;
                
                // Renderizar tabla
                renderRankingTable(rankingData);
                
                // Mostrar estado de √©xito
                showRankingState('success');
                
            } catch (error) {
                console.error('Error cargando ranking:', error);
                showRankingState('error', 'Error al cargar el ranking. Intenta de nuevo.');
            }
        }

        // ========================================
        // MOSTRAR ESTADOS
        // ========================================
        function showRankingState(state, errorMsg = '') {
            document.getElementById('ranking-loading').classList.add('hidden');
            document.getElementById('ranking-error').classList.add('hidden');
            document.getElementById('ranking-success').classList.add('hidden');
            
            if (state === 'loading') {
                document.getElementById('ranking-loading').classList.remove('hidden');
            } else if (state === 'error') {
                document.getElementById('error-text').textContent = errorMsg;
                document.getElementById('ranking-error').classList.remove('hidden');
            } else if (state === 'success') {
                document.getElementById('ranking-success').classList.remove('hidden');
            }
        }

        // ========================================
        // RENDERIZAR TABLA
        // ========================================
        function renderRankingTable(data) {
            const tbody = document.getElementById('ranking-list');
            tbody.innerHTML = '';
            
            data.forEach((player, index) => {
                const position = index + 1;
                const tr = document.createElement('tr');
                
                // Agregar clase especial para top 3
                if (position <= 3) {
                    tr.className = `rank-${position}`;
                }
                
                // Posici√≥n
                let positionDisplay;
                if (position === 1) positionDisplay = 'ü•á';
                else if (position === 2) positionDisplay = 'ü•à';
                else if (position === 3) positionDisplay = 'ü•â';
                else positionDisplay = position;
                
                tr.innerHTML = `
                    <td class="position">${positionDisplay}</td>
                    <td class="player">${player.name}</td>
                    <td class="score">${player.score.toLocaleString()}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // ========================================
        // ABRIR RANKING NATIVO (Google Play Games)
        // ========================================
        function openNativeRanking() {
            console.log('üèÜ Abriendo ranking nativo de Google Play Games...');
            // Aqu√≠ ir√≠a la llamada al plugin nativo
            alert('Abriendo ranking nativo...');
        }
        
        // ===== LEER MODO SELECCIONADO DESDE PANTALLA DE INICIO =====
        function getSelectedMode() {
            const savedMode = localStorage.getItem('memoflip_selected_mode');
            return savedMode || 'normal';
        }

        // ===== SELECTOR DE MODO BONITO =====
        function toggleModeSelector() {
            const dropdown = document.getElementById('modeDropdown');
            const pill = document.getElementById('modePill');
            
            dropdown.classList.toggle('open');
            pill.classList.toggle('open');
        }

        function changeMode(newMode) {
            console.log('üîÑ FUNCI√ìN changeMode LLAMADA con:', newMode);
            // Guardar modo seleccionado
            localStorage.setItem('memoflip_selected_mode', newMode);
            currentMode = newMode;
            
            // Guardar modo en Firestore si hay usuario logueado
            const user = localStorage.getItem('user');
            console.log('üîç Usuario encontrado:', !!user);
            console.log('üîç AndroidInterface disponible:', !!window.AndroidInterface);
            console.log('üîç saveGameProgress disponible:', !!(window.AndroidInterface && window.AndroidInterface.saveGameProgress));
            
            if (user && window.AndroidInterface && window.AndroidInterface.saveGameProgress) {
                try {
                    const userData = JSON.parse(user);
                    const progressData = {
                        uid: userData.uid,
                        nick: userData.nick,
                        email: userData.email,
                        displayName: userData.displayName,
                        selectedMode: newMode,
                        lastUpdated: new Date().toISOString()
                    };
                    console.log('üì§ Enviando datos a Firestore:', progressData);
                    window.AndroidInterface.saveGameProgress(JSON.stringify(progressData));
                    console.log('üéØ Modo guardado en Firestore desde juego:', newMode);
                } catch (error) {
                    console.error('‚ùå Error guardando modo en Firestore:', error);
                }
            } else {
                console.log('‚ö†Ô∏è No se puede guardar en Firestore - condiciones no cumplidas');
            }
            
            // Cargar progreso del nuevo modo
            loadGameProgress();
            
            // Actualizar pill
            const modeNames = {
                'beginner': { text: 'Relax', icon: 'relax.png' },
                'normal': { text: 'Normal', icon: 'normal.png' },
                'extreme': { text: 'Extremo', icon: 'extremo.png' }
            };
            
            const modeData = modeNames[newMode];
            document.getElementById('modeIcon').src = modeData.icon;
            document.getElementById('modeText').textContent = modeData.text;
            
            // Cerrar dropdown
            const dropdown = document.getElementById('modeDropdown');
            const pill = document.getElementById('modePill');
            dropdown.classList.remove('open');
            pill.classList.remove('open');
            
            // Aplicar clase CSS del modo al pill
            pill.classList.remove('beginner', 'normal', 'extreme');
            pill.classList.add(newMode);
            
            // Actualizar opciones activas
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Activar la opci√≥n correspondiente al modo seleccionado
            const modeButtons = {
                'beginner': document.querySelector('.mode-option[onclick*="beginner"]'),
                'normal': document.querySelector('.mode-option[onclick*="normal"]'),
                'extreme': document.querySelector('.mode-option[onclick*="extreme"]')
            };
            
            if (modeButtons[newMode]) {
                modeButtons[newMode].classList.add('active');
            }
            
            // Mostrar frase motivacional seg√∫n el modo
            showModeMotivationalMessage(newMode);
            
            // Reiniciar juego con nuevo modo
            initGame();
        }

        // ===== FRASES MOTIVACIONALES POR MODO =====
        function showModeMotivationalMessage(mode) {
            console.log('üéØ Mostrando mensaje motivacional para modo:', mode);
            const messages = {
                'beginner': {
                    title: 'üåø Modo Relax',
                    message: '¬°Perfecto para relajarte! Sin presi√≥n de tiempo, disfruta del juego a tu ritmo y mejora tu memoria de forma tranquila.'
                },
                'normal': {
                    title: '‚ö° Modo Normal',
                    message: '¬°El equilibrio perfecto! Tienes tiempo limitado para completar cada nivel. ¬°Demuestra tu habilidad y concentraci√≥n!'
                },
                'extreme': {
                    title: 'üî• Modo Extremo',
                    message: '¬°Est√°s preparado para el desaf√≠o m√°ximo! Cada nivel te retar√° con mec√°nicas especiales y tiempo muy limitado. ¬°Demuestra que eres un verdadero maestro de la memoria!'
                }
            };

            const messageData = messages[mode];
            if (messageData) {
                // Crear modal temporal para mostrar el mensaje
                showTemporaryMessage(messageData.title, messageData.message, mode);
            }
        }

        // ===== MOSTRAR MENSAJE TEMPORAL =====
        function showTemporaryMessage(title, message, mode = 'normal') {
            console.log('üé® showTemporaryMessage llamado con modo:', mode);
            // Colores seg√∫n el modo (iguales que en la pantalla de inicio)
            const modeColors = {
                'beginner': {
                    background: 'rgba(250, 204, 21, 0.3)',
                    border: '2px solid #facc15',
                    titleColor: '#facc15',
                    boxShadow: '0 4px 12px rgba(250, 204, 21, 0.3)'
                },
                'normal': {
                    background: 'rgba(59, 130, 246, 0.3)',
                    border: '2px solid #2fdde6',
                    titleColor: '#2fdde6',
                    boxShadow: '0 4px 12px rgba(59, 130, 246, 0.3)'
                },
                'extreme': {
                    background: 'rgba(239, 68, 68, 0.3)',
                    border: '2px solid #ef4444',
                    titleColor: '#ef4444',
                    boxShadow: '0 4px 12px rgba(239, 68, 68, 0.3)'
                }
            };

            const colors = modeColors[mode] || modeColors['normal'];
            console.log('üé® Colores aplicados para modo', mode, ':', colors);

            // Crear overlay
            const overlay = document.createElement('div');
            overlay.className = 'temp-message-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            // Crear modal
            const modal = document.createElement('div');
            modal.className = 'temp-message-modal';
            modal.style.cssText = `
                background: ${colors.background};
                border-radius: 20px;
                padding: 24px;
                max-width: 320px;
                text-align: center;
                box-shadow: ${colors.boxShadow};
                border: ${colors.border};
                animation: slideIn 0.3s ease-out;
            `;
            console.log('üé® Modal creado con estilos:', modal.style.cssText);

            modal.innerHTML = `
                <div style="position: relative;">
                    <button class="close-btn" style="position: absolute; top: -8px; right: -8px; background: rgba(34, 197, 94, 0.9); color: white; border: none; border-radius: 12px; width: 32px; height: 24px; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">OK</button>
                    <h3 style="color: ${colors.titleColor}; font-size: 18px; font-weight: 700; margin: 0 0 12px 0; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);">
                        ${title}
                    </h3>
                    <p style="color: rgba(255, 255, 255, 0.9); font-size: 14px; line-height: 1.5; margin: 0; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">
                        ${message}
                    </p>
                </div>
            `;

            // A√±adir animaci√≥n CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-20px) scale(0.9);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
            `;
            document.head.appendChild(style);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            console.log('üé® Modal creado y a√±adido al DOM');

            // Funci√≥n para cerrar el modal
            const closeModal = () => {
                overlay.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    if (style.parentNode) {
                        style.parentNode.removeChild(style);
                    }
                }, 300);
            };

            // Cerrar al hacer clic en el bot√≥n X
            const closeBtn = modal.querySelector('.close-btn');
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeModal();
            });

            // Cerrar al hacer clic fuera del modal
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeModal();
                }
            });

            // A√±adir animaci√≥n de salida
            const exitStyle = document.createElement('style');
            exitStyle.textContent = `
                @keyframes slideOut {
                    from {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                    to {
                        opacity: 0;
                        transform: translateY(-20px) scale(0.9);
                    }
                }
            `;
            document.head.appendChild(exitStyle);
        }

        // ===== ACTUALIZAR MODO EN CONFIGURACI√ìN =====
        function updateModeInSettings() {
            const selectedMode = getSelectedMode();
            currentMode = selectedMode;
            
            // Actualizar pill
            const modeNames = {
                'beginner': { text: 'Relax', icon: 'relax.png' },
                'normal': { text: 'Normal', icon: 'normal.png' },
                'extreme': { text: 'Extremo', icon: 'extremo.png' }
            };
            
            const modeData = modeNames[selectedMode];
            document.getElementById('modeIcon').src = modeData.icon;
            document.getElementById('modeText').textContent = modeData.text;
            
            // Aplicar clase CSS del modo al pill
            const pill = document.getElementById('modePill');
            pill.classList.remove('beginner', 'normal', 'extreme');
            pill.classList.add(selectedMode);
            
            // Actualizar botones en configuraci√≥n
            document.querySelectorAll('.mode-button').forEach(btn => {
                btn.classList.remove('active');
                btn.querySelector('.mode-indicator').classList.remove('active');
            });
            
            const activeButton = document.getElementById(`mode-${selectedMode}`);
            if (activeButton) {
                activeButton.classList.add('active');
                activeButton.querySelector('.mode-indicator').classList.add('active');
            }
        }

        // Funci√≥n para guardar datos en Firestore
        window.saveToFirestore = function() {
            try {
                const memoflipUser = localStorage.getItem('memoflip_user');
                if (memoflipUser && window.AndroidInterface && window.AndroidInterface.saveUserData) {
                    console.log('üî• Guardando en Firestore desde game.html...');
                    window.AndroidInterface.saveUserData(memoflipUser);
                    console.log('‚úÖ Datos enviados a Firestore');
                } else {
                    console.log('‚ùå No se puede guardar en Firestore:', {
                        memoflipUser: !!memoflipUser,
                        AndroidInterface: !!window.AndroidInterface,
                        saveUserData: !!(window.AndroidInterface && window.AndroidInterface.saveUserData)
                    });
                }
            } catch (error) {
                console.error('‚ùå Error guardando en Firestore:', error);
            }
        };

        // ===== SISTEMA COMPLETO DE GUARDADO POR MODO =====
        
        // Funci√≥n para obtener progreso por modo
        function getModeProgress(mode) {
            const key = `memoflip_progress_${mode}`;
            const saved = localStorage.getItem(key);
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                level: 1,
                coins: 0,
                bestTime: null,
                bestFlips: null,
                totalGames: 0,
                totalWins: 0
            };
        }
        
        // Funci√≥n para guardar progreso por modo
        function saveModeProgress(mode, progress) {
            const key = `memoflip_progress_${mode}`;
            localStorage.setItem(key, JSON.stringify(progress));
            console.log(`üíæ Progreso guardado para modo ${mode}:`, progress);
        }
        
        // Funci√≥n para obtener configuraciones
        function getSettings() {
            const saved = localStorage.getItem('memoflip_settings');
            if (saved) {
                return JSON.parse(saved);
            }
            return {
                soundEnabled: true,
                vibrationEnabled: true,
                musicVolume: 0.7,
                soundVolume: 0.8
            };
        }
        
        // Funci√≥n para guardar configuraciones
        function saveSettings(settings) {
            localStorage.setItem('memoflip_settings', JSON.stringify(settings));
            console.log('‚öôÔ∏è Configuraciones guardadas:', settings);
        }
        
        // Funci√≥n para guardar progreso del juego (COMPLETA)
        window.saveGameProgress = function() {
            try {
                const memoflipUser = localStorage.getItem('user');
                console.log('üîç Verificando AndroidInterface.saveGameProgress:', !!(window.AndroidInterface && window.AndroidInterface.saveGameProgress));
                if (memoflipUser && window.AndroidInterface && window.AndroidInterface.saveGameProgress) {
                    const user = JSON.parse(memoflipUser);
                    const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                    const currentLevelElement = document.getElementById('currentLevel');
                    const currentLevel = currentLevelElement ? parseInt(currentLevelElement.textContent) || 1 : 1;
                    
                    const coinElement = document.getElementById('coin-counter');
                    const currentCoins = coinElement ? parseInt(coinElement.textContent) || 0 : 0;
                    
                    // Obtener progreso actual del modo
                    const modeProgress = getModeProgress(currentMode);
                    
                    // Actualizar progreso del modo actual
                    const updatedProgress = {
                        ...modeProgress,
                        level: Math.max(modeProgress.level, currentLevel),
                        coins: currentCoins,
                        lastPlayed: new Date().toISOString()
                    };
                    
                    // Guardar progreso local
                    saveModeProgress(currentMode, updatedProgress);
                    
                    // Obtener configuraciones (solo las necesarias)
                    const settings = getSettings();
                    const simplifiedSettings = {
                        soundEnabled: settings.soundEnabled,
                        vibrationEnabled: settings.vibrationEnabled
                    };
                    
                    // Obtener modo seleccionado
                    const selectedMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
                    
                    // Obtener datos de vidas
                    const currentLives = window.LifeSystem ? window.LifeSystem.getCurrentLives() : 3;
                    const lastLifeRegen = window.LifeSystem ? window.LifeSystem.getLastRegenTime() : new Date().toISOString();
                    
                    // Preparar progreso simplificado (sin campos innecesarios)
                    const simplifiedProgress = {
                        beginner: {
                            level: getModeProgress('beginner').level,
                            coins: getModeProgress('beginner').coins,
                            totalGames: getModeProgress('beginner').totalGames,
                            totalWins: getModeProgress('beginner').totalWins,
                            lastPlayed: getModeProgress('beginner').lastPlayed
                        },
                        normal: {
                            level: getModeProgress('normal').level,
                            coins: getModeProgress('normal').coins,
                            totalGames: getModeProgress('normal').totalGames,
                            totalWins: getModeProgress('normal').totalWins,
                            lastPlayed: getModeProgress('normal').lastPlayed
                        },
                        extreme: {
                            level: getModeProgress('extreme').level,
                            coins: getModeProgress('extreme').coins,
                            totalGames: getModeProgress('extreme').totalGames,
                            totalWins: getModeProgress('extreme').totalWins,
                            lastPlayed: getModeProgress('extreme').lastPlayed
                        }
                    };
                    
                    // Preparar datos para Firestore (SIN DUPLICACI√ìN)
                    const progressData = {
                        uid: user.uid,
                        nick: user.nick,
                        email: user.email,
                        displayName: user.displayName,
                        currentLives: currentLives,
                        lastLifeRegen: lastLifeRegen,
                        selectedMode: selectedMode,
                        progress: simplifiedProgress,
                        settings: simplifiedSettings,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    console.log('üéÆ Guardando progreso completo del juego:', progressData);
                    window.AndroidInterface.saveGameProgress(JSON.stringify(progressData));
                    console.log('‚úÖ Progreso completo enviado a Firestore');
                } else {
                    console.log('‚ùå No se puede guardar progreso:', {
                        user: !!memoflipUser,
                        AndroidInterface: !!window.AndroidInterface,
                        saveGameProgress: !!(window.AndroidInterface && window.AndroidInterface.saveGameProgress)
                    });
                }
            } catch (error) {
                console.error('‚ùå Error guardando progreso:', error);
            }
        };
        
        // Funci√≥n para cargar configuraciones al iniciar
        function loadSettings() {
            const settings = getSettings();
            
            // Aplicar configuraciones a las variables globales
            soundEnabled = settings.soundEnabled;
            vibrationEnabled = settings.vibrationEnabled;
            
            // Actualizar UI de configuraciones
            updateSettingsUI();
            
            console.log('‚öôÔ∏è Configuraciones cargadas:', settings);
        }
        
        // Funci√≥n para actualizar la UI de configuraciones
        function updateSettingsUI() {
            // Actualizar sonido
            const soundIcon = document.getElementById('sound-icon');
            const soundName = document.getElementById('sound-name');
            const soundDesc = document.getElementById('sound-desc');
            const soundToggle = document.getElementById('sound-toggle');
            
            if (soundEnabled) {
                soundIcon.textContent = 'üîä';
                soundName.textContent = 'Sonido Activado';
                soundDesc.textContent = 'M√∫sica y efectos activos';
                soundToggle.textContent = 'Desactivar';
                soundToggle.classList.add('active');
            } else {
                soundIcon.textContent = 'üîá';
                soundName.textContent = 'Sonido Desactivado';
                soundDesc.textContent = 'Modo silencioso';
                soundToggle.textContent = 'Activar';
                soundToggle.classList.remove('active');
            }
            
            // Actualizar vibraci√≥n
            const vibrationIcon = document.getElementById('vibration-icon');
            const vibrationName = document.getElementById('vibration-name');
            const vibrationDesc = document.getElementById('vibration-desc');
            const vibrationToggle = document.getElementById('vibration-toggle');
            
            if (vibrationEnabled) {
                vibrationIcon.textContent = 'üì±';
                vibrationName.textContent = 'Vibraci√≥n Activada';
                vibrationDesc.textContent = 'Vibraci√≥n al tocar cartas';
                vibrationToggle.textContent = 'Desactivar';
                vibrationToggle.classList.add('active');
            } else {
                vibrationIcon.textContent = 'üìµ';
                vibrationName.textContent = 'Vibraci√≥n Desactivada';
                vibrationDesc.textContent = 'Sin vibraci√≥n';
                vibrationToggle.textContent = 'Activar';
                vibrationToggle.classList.remove('active');
            }
        }
        
        // Funci√≥n para cargar progreso al iniciar
        function loadGameProgress() {
            const currentMode = localStorage.getItem('memoflip_selected_mode') || 'normal';
            const modeProgress = getModeProgress(currentMode);
            
            // Cargar nivel del modo
            currentLevel = modeProgress.level;
            document.getElementById('currentLevel').textContent = currentLevel;
            
            // Cargar monedas del modo
            const coinElement = document.getElementById('coin-counter');
            if (coinElement) {
                coinElement.textContent = modeProgress.coins;
            }
            
            // Cargar configuraciones
            const settings = getSettings();
            if (window.CoinSystem) {
                window.CoinSystem.setCoins(modeProgress.coins);
            }
            
            console.log(`üìÇ Progreso cargado para modo ${currentMode}:`, modeProgress);
            console.log('‚öôÔ∏è Configuraciones cargadas:', settings);
        }
        
        // Callback para manejar respuesta de guardado de progreso
        window.__onSaveGameProgress = function(success, error) {
            if (success) {
                console.log('‚úÖ Progreso del juego guardado exitosamente en Firestore');
            } else {
                console.error('‚ùå Error guardando progreso del juego:', error);
            }
        };
        
        // Callback para cuando se reciben datos del usuario desde Firestore
        window.__onUserData = function(userDataJson) {
            try {
                const userData = JSON.parse(userDataJson);
                console.log('üì• Datos de usuario recibidos desde Firestore:', userData);
                
                // Actualizar modo si est√° disponible en Firestore
                if (userData.selectedMode && userData.selectedMode !== currentMode) {
                    console.log('üîÑ Actualizando modo desde Firestore:', userData.selectedMode);
                    currentMode = userData.selectedMode;
                    localStorage.setItem('memoflip_selected_mode', userData.selectedMode);
                    
                    // Recargar niveles del modo correcto
                    loadLevelsData().then(() => {
                        console.log('‚úÖ Niveles recargados para modo desde Firestore');
                        updateUI();
                        generateCards();
                    }).catch((error) => {
                        console.error('‚ùå Error recargando niveles:', error);
                    });
                }
                
                // Actualizar configuraciones si est√°n disponibles
                if (userData.settings) {
                    if (userData.settings.soundEnabled !== undefined) {
                        soundEnabled = userData.settings.soundEnabled;
                    }
                    if (userData.settings.vibrationEnabled !== undefined) {
                        vibrationEnabled = userData.settings.vibrationEnabled;
                    }
                    updateSettingsUI();
                    console.log('‚öôÔ∏è Configuraciones actualizadas desde Firestore');
                }
                
            } catch (error) {
                console.error('‚ùå Error procesando datos de usuario:', error);
            }
        };

        // Cargar nick del usuario
        window.loadUserNick = function() {
            try {
                console.log('üîç Buscando datos de usuario...');
                
                // Debug: mostrar todo el localStorage
                console.log('üîç Todo el localStorage:');
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    console.log(`  ${key}:`, localStorage.getItem(key));
                }
                
                // Buscar en localStorage
                const userData = localStorage.getItem('user');
                const memoflipUser = localStorage.getItem('memoflip_user');
                
                console.log('üì± localStorage.user:', userData);
                console.log('üì± localStorage.memoflip_user:', memoflipUser);
                
                // Priorizar memoflip_user sobre user
                if (memoflipUser) {
                    const user = JSON.parse(memoflipUser);
                    console.log('üë§ Datos de memoflip_user parseados:', user);
                    const nick = user.nick || 'Invitado';
                    document.getElementById('userNick').textContent = nick;
                    console.log('üë§ Nick cargado desde memoflip_user:', nick);
                } else if (userData) {
                    const user = JSON.parse(userData);
                    console.log('üë§ Datos de user parseados:', user);
                    const nick = user.nick || 'Invitado';
                    document.getElementById('userNick').textContent = nick;
                    console.log('üë§ Nick cargado desde user:', nick);
                } else {
                    document.getElementById('userNick').textContent = 'Invitado';
                    console.log('üë§ Usando nick por defecto - no hay datos de usuario');
                }
            } catch (error) {
                console.error('‚ùå Error cargando nick:', error);
                document.getElementById('userNick').textContent = 'Invitado';
            }
        };

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar AndroidInterface
            console.log('üîç AndroidInterface disponible:', !!window.AndroidInterface);
            console.log('üîç AndroidInterface.saveGameProgress disponible:', !!(window.AndroidInterface && window.AndroidInterface.saveGameProgress));
            
            // Cargar configuraciones guardadas
            loadSettings();
            
            // Cargar nick del usuario
            window.loadUserNick();
            
            // Cargar progreso del juego
            loadGameProgress();
            
            // Inicializar sistemas
            LifeSystem.init();
            CoinSystem.init();
            
            // Actualizar timer de vida cada segundo
            setInterval(() => {
                LifeSystem.updateDisplay();
            }, 1000);
            
            updateModeInSettings();
            initGame();
        });
    </script>
</body>
</html>
